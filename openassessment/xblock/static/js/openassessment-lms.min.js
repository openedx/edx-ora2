if("undefined"!=typeof OpenAssessment&&OpenAssessment||(OpenAssessment={}),void 0===window.gettext&&(window.gettext=function(text){return text}),void 0===window.ngetgext&&(window.ngettext=function(singularText,pluralText,n){return 1<n?pluralText:singularText}),void 0===window.Logger&&(window.Logger={log:function(){}}),void 0===window.MathJax&&(window.MathJax={Hub:{Typeset:function(){},Queue:function(){}}}),void 0===OpenAssessment.Server||!OpenAssessment.Server){OpenAssessment.Server=function(runtime,element){this.runtime=runtime,this.element=element};var jsonContentType="application/json; charset=utf-8";OpenAssessment.Server.prototype={url:function(handler){return this.runtime.handlerUrl(this.element,handler)},render:function(component){var view=this,url=this.url("render_"+component);return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(view,[data])}).fail(function(){defer.rejectWith(view,[gettext("This section could not be loaded.")])})}).promise()},renderLatex:function(element){element.filter(".allow--latex").each(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,this])})},renderContinuedPeer:function(){var view=this,url=this.url("render_peer_assessment");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html",data:{continue_grading:!0}}).done(function(data){defer.resolveWith(view,[data])}).fail(function(){defer.rejectWith(view,[gettext("This section could not be loaded.")])})}).promise()},studentInfo:function(studentUsername,options){var url=this.url("render_student_info");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html",data:_.extend({student_username:studentUsername},options)}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("This section could not be loaded.")])})}).promise()},staffGradeForm:function(){var url=this.url("render_staff_grade_form");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("The staff assessment form could not be loaded.")])})}).promise()},staffGradeCounts:function(){var url=this.url("render_staff_grade_counts");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("The display of ungraded and checked out responses could not be loaded.")])})}).promise()},submit:function(submission){var url=this.url("submit");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({submission:submission}),contentType:jsonContentType}).done(function(data){if(data[0]){var studentId=data[1],attemptNum=data[2];defer.resolveWith(this,[studentId,attemptNum])}else{var errorNum=data[1],errorMsg=data[2];defer.rejectWith(this,[errorNum,errorMsg])}}).fail(function(){defer.rejectWith(this,["AJAX",gettext("This response could not be submitted.")])})}).promise()},save:function(submission){var url=this.url("save_submission");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({submission:submission}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This response could not be saved.")])})}).promise()},submitFeedbackOnAssessment:function(text,options){var url=this.url("submit_feedback"),payload=JSON.stringify({feedback_text:text,feedback_options:options});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This feedback could not be submitted.")])})}).promise()},submitAssessment:function(assessmentType,payload){var url=this.url(assessmentType);return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify(payload),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})}).promise()},peerAssess:function(optionsSelected,criterionFeedback,overallFeedback,submissionID){return this.submitAssessment("peer_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback,submission_uuid:submissionID})},selfAssess:function(optionsSelected,criterionFeedback,overallFeedback){return this.submitAssessment("self_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback})},staffAssess:function(optionsSelected,criterionFeedback,overallFeedback,submissionID,assessType){return this.submitAssessment("staff_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback,submission_uuid:submissionID,assess_type:assessType})},trainingAssess:function(optionsSelected){var url=this.url("training_assess"),payload=JSON.stringify({options_selected:optionsSelected});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.corrections]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})})},scheduleTraining:function(){var url=this.url("schedule_training");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.msg]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})})},rescheduleUnfinishedTasks:function(){var url=this.url("reschedule_unfinished_tasks");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.msg]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("One or more rescheduling tasks failed.")])})})},updateEditorContext:function(options){var url=this.url("update_editor_context"),payload=JSON.stringify({prompts:options.prompts,prompts_type:options.prompts_type,feedback_prompt:options.feedbackPrompt,feedback_default_text:options.feedback_default_text,title:options.title,submission_start:options.submissionStart,submission_due:options.submissionDue,criteria:options.criteria,assessments:options.assessments,editor_assessments_order:options.editorAssessmentsOrder,text_response:options.textResponse,file_upload_response:options.fileUploadResponse,file_upload_type:options.fileUploadType,white_listed_file_types:options.fileTypeWhiteList,allow_latex:options.latexEnabled,leaderboard_show:options.leaderboardNum});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This problem could not be saved.")])})}).promise()},checkReleased:function(){var url=this.url("check_released");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.is_released]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("The server could not be contacted.")])})}).promise()},getUploadUrl:function(contentType,filename,filenum){var url=this.url("upload_url");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({contentType:contentType,filename:filename,filenum:filenum}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve(data.url):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Could not retrieve upload url.")])})}).promise()},removeUploadedFiles:function(){var url=this.url("remove_all_uploaded_files");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Server error.")])})}).promise()},saveFilesDescriptions:function(descriptions){var url=this.url("save_files_descriptions");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({descriptions:descriptions}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Server error.")])})}).promise()},getDownloadUrl:function(filenum){var url=this.url("download_url");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({filenum:filenum}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve(data.url):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Could not retrieve download url.")])})}).promise()},cancelSubmission:function(submissionID,comments){var url=this.url("cancel_submission"),payload=JSON.stringify({submission_uuid:submissionID,comments:comments});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success&&defer.resolveWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("The submission could not be removed from the grading pool.")])})}).promise()},publishEvent:function(eventName,eventData){eventData.event_name=eventName;var url=this.url("publish_event"),payload=JSON.stringify(eventData);$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType})}}}function OpenAssessmentBlock(runtime,element,data){var server=new OpenAssessment.Server(runtime,element);new OpenAssessment.BaseView(runtime,element,server,data).load()}function CourseOpenResponsesListingBlock(runtime,element,data){new OpenAssessment.CourseItemsListingView(runtime,element).refreshGrids()}function StaffAssessmentBlock(runtime,element,data){var server=new OpenAssessment.Server(runtime,element);new OpenAssessment.BaseView(runtime,element,server,data).staffAreaView.installHandlers()}OpenAssessment.BaseView=function(runtime,element,server,data){this.runtime=runtime,this.element=element,this.server=server,this.fileUploader=new OpenAssessment.FileUploader,this.responseView=new OpenAssessment.ResponseView(this.element,this.server,this.fileUploader,this,data),this.trainingView=new OpenAssessment.StudentTrainingView(this.element,this.server,this),this.selfView=new OpenAssessment.SelfView(this.element,this.server,this),this.peerView=new OpenAssessment.PeerView(this.element,this.server,this),this.staffView=new OpenAssessment.StaffView(this.element,this.server,this),this.gradeView=new OpenAssessment.GradeView(this.element,this.server,this),this.leaderboardView=new OpenAssessment.LeaderboardView(this.element,this.server,this),this.messageView=new OpenAssessment.MessageView(this.element,this.server,this),this.staffAreaView=new OpenAssessment.StaffAreaView(this.element,this.server,this),this.usageID="",this.srStatusUpdates=[]},void 0!==OpenAssessment.unsavedChanges&&OpenAssessment.unsavedChanges||(OpenAssessment.unsavedChanges={}),OpenAssessment.clearUnsavedChanges=function(){OpenAssessment.unsavedChanges={},window.onbeforeunload=null},OpenAssessment.BaseView.prototype={IS_SHOWING_CLASS:"is--showing",SLIDABLE_CLASS:"ui-slidable",SLIDABLE_CONTENT_CLASS:"ui-slidable__content",SLIDABLE_CONTROLS_CLASS:"ui-slidable__control",SLIDABLE_CONTAINER_CLASS:"ui-slidable__container",READER_FEEDBACK_CLASS:".sr.reader-feedback",scrollToTop:function(selector){selector||(selector=".openassessment__steps"),$.scrollTo instanceof Function&&($(window).scrollTo($(selector,this.element),800,{offset:-50}),$(selector+" > header ."+this.SLIDABLE_CLASS,this.element).focus())},srClear:function(){$(this.READER_FEEDBACK_CLASS).html("")},srReadTexts:function(texts){var $readerFeedbackSelector=$(this.READER_FEEDBACK_CLASS),htmlFeedback="";this.srClear(),$.each(texts,function(ids,value){htmlFeedback=htmlFeedback+"<p>"+value+"</p>\n"}),$readerFeedbackSelector.html(htmlFeedback)},areSRStepsLoading:function(){return this.responseView.isRendering||this.peerView.isRendering||this.selfView.isRendering||this.gradeView.isRendering||this.trainingView.isRendering||this.staffView.isRendering},announceStatusChangeToSRandFocus:function(stepID,usageID,gradeStatus,currentView,focusID){var text=this.getStatus(stepID,currentView,gradeStatus);void 0!==usageID&&$(stepID,currentView.element).hasClass("is--showing")&&void 0!==focusID?($(focusID,currentView.element).focus(),this.srStatusUpdates.push(text)):currentView.announceStatus&&this.srStatusUpdates.push(text),!this.areSRStepsLoading()&&0<this.srStatusUpdates.length&&(this.srReadTexts(this.srStatusUpdates),this.srStatusUpdates=[]),currentView.announceStatus=!1},getStatus:function(stepID,currentView,gradeStatus){var cssBase=stepID+" .step__header .step__title ",cssStringStatus=cssBase+".step__status";return gradeStatus&&(cssStringStatus=cssBase+".grade__value"),$(cssBase+".step__label",currentView.element).text().trim()+" "+$(cssStringStatus,currentView.element).text().trim()},setUpCollapseExpand:function(parentElement){var view=this;$("."+view.SLIDABLE_CONTROLS_CLASS,parentElement).each(function(){$(this).on("click",function(event){event.preventDefault();var $slidableControl=$(event.target).closest("."+view.SLIDABLE_CONTROLS_CLASS),$container=$slidableControl.closest("."+view.SLIDABLE_CONTAINER_CLASS),$toggleButton=$slidableControl.find("."+view.SLIDABLE_CLASS),$panel=$slidableControl.next("."+view.SLIDABLE_CONTENT_CLASS);$container.hasClass("is--showing")?($panel.slideUp(),$toggleButton.attr("aria-expanded","false"),$container.removeClass("is--showing")):$container.hasClass("has--error")||$container.hasClass("is--empty")||$container.hasClass("is--unavailable")||($panel.slideDown(),$toggleButton.attr("aria-expanded","true"),$container.addClass("is--showing")),$container.removeClass("is--initially--collapsed ")})})},bindLatexPreview:function(parentElement){parentElement.find(".submission__preview__item").hide(),parentElement.find(".submission__preview").click(function(eventObject){eventObject.preventDefault();var previewName=$(eventObject.target).data("input"),previewText=parentElement.find('textarea[data-preview="'+previewName+'"]').val(),previewContainer=parentElement.find('.preview_content[data-preview="'+previewName+'"]');previewContainer.html(previewText.replace(/\r\n|\r|\n/g,"<br />")),previewContainer.parent().parent().parent().show(),MathJax.Hub.Queue(["Typeset",MathJax.Hub,previewContainer[0]])})},getUsageID:function(){return this.usageID||(this.usageID=$(this.element).data("usage-id")),this.usageID},load:function(){this.responseView.load(),this.loadAssessmentModules(),this.staffAreaView.load()},loadAssessmentModules:function(usageID){this.trainingView.load(usageID),this.peerView.load(usageID),this.staffView.load(usageID),this.selfView.load(usageID),this.gradeView.load(usageID),this.leaderboardView.load(usageID)},loadMessageView:function(){this.messageView.load()},toggleActionError:function(type,message){var element=this.element,container=null;if("save"===type?container=".response__submission__actions":"submit"===type||"peer"===type||"self"===type||"student-training"===type?container=".step__actions":"feedback_assess"===type?container=".submission__feedback__actions":"upload"===type&&(container=".upload__error"),null===container?null!==message&&console.log(message):($(container+" .message__content",element).html("<p>"+(message?_.escape(message):"")+"</p>"),$(container,element).toggleClass("has--error",null!==message),$(container+" > .message",element).focus()),null!==message){var contentTitle=$(container+" .message__title").text();this.srReadTexts([contentTitle,message])}},showLoadError:function(stepName,errorMessage){errorMessage||(errorMessage=gettext("Unable to load"));var $container=$(".step--"+stepName);$container.toggleClass("has--error",!0),$container.removeClass("is--showing"),$container.find(".ui-slidable").attr("aria-expanded","false"),$container.find(".step__status__value i").removeClass().addClass("icon fa fa-exclamation-triangle"),$container.find(".step__status__value .copy").html(_.escape(errorMessage))},unsavedWarningEnabled:function(enabled,key,message){if(void 0===enabled)return null!==window.onbeforeunload;var usageID=$(this.element).data("usage-id");enabled?(void 0!==OpenAssessment.unsavedChanges[usageID]&&OpenAssessment.unsavedChanges[usageID]||(OpenAssessment.unsavedChanges[usageID]={}),OpenAssessment.unsavedChanges[usageID][key]=message,window.onbeforeunload=function(){for(var xblockUsageID in OpenAssessment.unsavedChanges)if(OpenAssessment.unsavedChanges.hasOwnProperty(xblockUsageID))for(var key in OpenAssessment.unsavedChanges[xblockUsageID])if(OpenAssessment.unsavedChanges[xblockUsageID].hasOwnProperty(key))return OpenAssessment.unsavedChanges[xblockUsageID][key]}):void 0!==OpenAssessment.unsavedChanges[usageID]&&(delete OpenAssessment.unsavedChanges[usageID][key],$.isEmptyObject(OpenAssessment.unsavedChanges[usageID])&&delete OpenAssessment.unsavedChanges[usageID],$.isEmptyObject(OpenAssessment.unsavedChanges)&&(window.onbeforeunload=null))},buttonEnabled:function(className,enabled){var $element=$(className,this.element);return void 0===enabled?!$element.prop("disabled"):($element.prop("disabled",!enabled),enabled)}},function(OpenAssessment){"use strict";OpenAssessment.CourseItemsListingView=function(runtime,element){var self=this,$section=$(element),block=$section.find(".open-response-assessment-block"),itemViewEnabled=1===parseInt(block.data("item-view-enabled"))&&XBlock;this.$section=$section,this.runtime=runtime,this.oraData=$.parseJSON($("#open-response-assessment-items").text()),$section.find(".open-response-assessment-content").hide(),$section.find(".open-response-assessment-item").hide(),$section.find(".open-response-assessment-msg").show();var AssessmentCell=Backgrid.UriCell.extend({staff:!1,render:function(){this.$el.empty();var url=this.model.get(this.staff?"url_grade_available_responses":"url_base"),rawValue=this.model.get(this.column.get("name")),staffAssessment=this.model.get("staff_assessment"),formattedValue=this.formatter.fromRaw(rawValue,this.model),link=null;return itemViewEnabled&&(!this.staff||this.staff&&staffAssessment)?(link=$("<a>",{text:formattedValue,title:this.title||formattedValue}),this.$el.append(link),link.on("click",$.proxy(self,"displayOraBlock",url))):this.$el.append(formattedValue),this.delegateEvents(),this}}),StaffCell=AssessmentCell.extend({staff:!0});this._columns=[{name:"parent_name",label:gettext("Unit Name"),label_summary:gettext("Units"),cell:"string",num:!1,editable:!1},{name:"name",label:gettext("Assessment"),label_summary:gettext("Assessments"),cell:AssessmentCell,num:!1,editable:!1},{name:"total",label:gettext("Total Responses"),label_summary:gettext("Total Responses"),cell:"string",num:!0,editable:!1},{name:"training",label:gettext("Training"),label_summary:gettext("Training"),cell:"string",num:!0,editable:!1},{name:"peer",label:gettext("Peer"),label_summary:gettext("Peer"),cell:"string",num:!0,editable:!1},{name:"self",label:gettext("Self"),label_summary:gettext("Self"),cell:"string",num:!0,editable:!1},{name:"waiting",label:gettext("Waiting"),label_summary:gettext("Waiting"),cell:"string",num:!0,editable:!1},{name:"staff",label:gettext("Staff"),label_summary:gettext("Staff"),cell:StaffCell,num:!0,editable:!1},{name:"done",label:gettext("Final Grade Received"),label_summary:gettext("Final Grade Received"),cell:"string",num:!0,editable:!1}]},OpenAssessment.CourseItemsListingView.prototype.refreshGrids=function(force){force=force||!1;var self=this,$section=this.$section,block=$section.find(".open-response-assessment-block"),dataUrl=this.runtime.handlerUrl($section,"get_ora2_responses");if(!parseInt(block.data("rendered"))||force)return $.Deferred(function(defer){$.ajax({type:"GET",dataType:"json",url:dataUrl}).done(function(data){self.renderGrids(data),defer.resolve()}).fail(function(data,textStatus){$section.find(".open-response-assessment-msg").text(gettext("List of Open Assessments is unavailable")),defer.rejectWith(this,[textStatus])})}).promise()},OpenAssessment.CourseItemsListingView.prototype.renderGrids=function(data){var $section=this.$section,block=$section.find(".open-response-assessment-block"),oraSteps=["training","peer","self","waiting","staff","done"];$.each(this.oraData,function(i,oraItem){var total=0,itemId=oraItem.id;$.each(oraSteps,function(j,step){oraItem[step]=0}),itemId in data&&(_.extend(oraItem,data[itemId]),oraItem.staff_assessment&&(oraItem.staff=oraItem.waiting,oraItem.waiting=0)),$.each(oraSteps,function(j,step){total+=oraItem[step]}),oraItem.total=total}),block.data("rendered",1),$section.find(".open-response-assessment-msg").hide(),this.showSummaryGrid(this.oraData),this.showOpenResponsesGrid(this.oraData)},OpenAssessment.CourseItemsListingView.prototype.showSummaryGrid=function(data){var $section=this.$section,summaryData=[],summaryDataMap={};$section.find(".open-response-assessment-summary").empty(),$.each(this._columns,function(index,v){summaryData.push({title:v.label_summary,value:0,num:v.num,class:v.name}),summaryDataMap[v.name]=index}),$.each(data,function(index,obj){$.each(obj,function(key,value){var idx=0;key in summaryDataMap&&(idx=summaryDataMap[key],summaryData[idx].num?summaryData[idx].value+=value:summaryData[idx].value+=1)})});var templateData=_.template($("#open-response-assessment-summary-tpl").text());$section.find(".open-response-assessment-summary").append(templateData({oraSummary:summaryData}))},OpenAssessment.CourseItemsListingView.prototype.showOpenResponsesGrid=function(data){var $section=this.$section;$section.find(".open-response-assessment-content").show();var collection=new Backbone.Collection(data);$section.find(".open-response-assessment-main-table").empty();var grid=new Backgrid.Grid({columns:this._columns,collection:collection});$section.find(".open-response-assessment-main-table").append(grid.render().el)},OpenAssessment.CourseItemsListingView.prototype.displayOraBlock=function(url){var $section=this.$section,self=this;return $section.find(".open-response-assessment-content").hide(),$section.find(".open-response-assessment-msg").text(gettext("Please wait")).show(),$.Deferred(function(defer){$.ajax({type:"GET",dataType:"json",url:url}).done(function(data){var el=$section.find(".open-response-assessment-item"),block=el.find(".open-response-assessment-item-block");$section.find(".open-response-assessment-msg").hide(),el.show(),self.renderBreadcrumbs(),block.html(data.html),XBlock.initializeBlock($(block).find(".xblock")[0]),defer.resolve()}).fail(function(data,textStatus){$section.find(".open-response-assessment-item").show(),$section.find(".open-response-assessment-msg").text(gettext("Block view is unavailable")),self.renderBreadcrumbs(),defer.rejectWith(this,[textStatus])})}).promise()},OpenAssessment.CourseItemsListingView.prototype.renderBreadcrumbs=function(){var breadcrumbs=this.$section.find(".open-response-assessment-item-breadcrumbs"),text=gettext("Back to Full List"),fullListItem=$("<a>",{html:"&larr;&nbsp;"+text,title:text});breadcrumbs.append(fullListItem),fullListItem.on("click",$.proxy(this,"backToOpenResponsesGrid"))},OpenAssessment.CourseItemsListingView.prototype.backToOpenResponsesGrid=function(){var $section=this.$section;$section.find(".open-response-assessment-item-breadcrumbs").empty(),$section.find(".open-response-assessment-item-block").empty(),$section.find(".open-response-assessment-item").hide(),$section.find(".open-response-assessment-msg").text(gettext("Please wait")).show(),this.refreshGrids(!0)}}(OpenAssessment),OpenAssessment.DateTimeFactory=function(element){this.element=element},OpenAssessment.DateTimeFactory.prototype={apply:function(){var dtFactory=this;$(".ora-datetime",this.element).each(function(){dtFactory.elementApply($(this))})},determineContext:function(el){return{datetime:el.data("datetime"),timezone:el.data("timezone"),language:el.data("language"),format:""}},determineDateToken:function(el){var dateToken="date";return this.isValid(el.data("datetoken"))&&(dateToken=el.data("datetoken")),dateToken},elementApply:function(el){var dtFactory=this;(function(require){require(["jquery","edx-ui-toolkit/js/utils/date-utils","edx-ui-toolkit/js/utils/string-utils"],function($,DateUtils,StringUtils){var context,localTimeString,displayDatetime,interpolateDict={};dtFactory.isValid(el.data("datetime"))?(context=dtFactory.determineContext(el),dtFactory.isValid(el.data("format"))&&(context.format=DateUtils.dateFormatEnum[el.data("format")]),localTimeString=DateUtils.localize(context),interpolateDict[dtFactory.determineDateToken(el)]=localTimeString,displayDatetime=dtFactory.isValid(el.data("string"))?StringUtils.interpolate(el.data("string"),interpolateDict):localTimeString):displayDatetime=StringUtils.interpolate(el.data("string"),interpolateDict),el.text(displayDatetime)})}).call(this,require||RequireJS.require)},isValid:function(candidateVariable){return void 0!==candidateVariable&&""!==candidateVariable&&"Invalid date"!==candidateVariable&&"None"!==candidateVariable}},OpenAssessment.FileUploader=function(){this.upload=function(url,file){return $.Deferred(function(defer){$.ajax({url:url,type:"PUT",data:file,async:!1,processData:!1,contentType:file.type}).done(function(){Logger.log("openassessment.upload_file",{fileName:file.name,fileSize:file.size,fileType:file.type}),defer.resolve()}).fail(function(data,textStatus){defer.rejectWith(this,[textStatus])})}).promise()}},OpenAssessment.GradeView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.announceStatus=!1,this.isRendering=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.GradeView.prototype={load:function(usageID){var view=this,baseView=this.baseView,stepID=".step--grade",focusID="[id='oa_grade_"+usageID+"']";view.isRendering=!0,this.server.render("grade").done(function(html){$(stepID,view.element).replaceWith(html),view.server.renderLatex($(stepID,view.element)),view.isRendering=!1,view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!0,view,focusID),view.dateFactory.apply()}).fail(function(errMsg){baseView.showLoadError("grade",errMsg)})},installHandlers:function(){var sel=$(".step--grade",this.element);this.baseView.setUpCollapseExpand(sel);var view=this;sel.find(".feedback__submit").click(function(eventObject){eventObject.preventDefault(),view.submitFeedbackOnAssessment()})},feedbackText:function(text){var usageID=this.baseView.getUsageID()||"";if(void 0===text)return $("[id='feedback__remarks__value__"+usageID+"']",this.element).val();$("[id='feedback__remarks__value__"+usageID+"']",this.element).val(text)},feedbackOptions:function(options){var view=this,usageID=this.baseView.getUsageID()||"";if(void 0===options)return $.map($(".feedback__overall__value:checked",view.element),function(element){return $(element).val()});$(".feedback__overall__value",this.element).prop("checked",!1),$.each(options,function(index,opt){$("[id='feedback__overall__value--"+opt+"__"+usageID+"']",view.element).prop("checked",!0)})},setHidden:function(selector,hidden){selector.toggleClass("is--hidden",hidden),selector.attr("aria-hidden",hidden?"true":"false")},isHidden:function(selector){return selector.hasClass("is--hidden")&&"true"===selector.attr("aria-hidden")},feedbackState:function(newState){var containerSel=$(".submission__feedback__content",this.element),instructionsSel=containerSel.find(".submission__feedback__instructions"),fieldsSel=containerSel.find(".submission__feedback__fields"),actionsSel=containerSel.find(".submission__feedback__actions"),transitionSel=containerSel.find(".transition__status"),messageSel=containerSel.find(".message--complete");if(void 0===newState){var isSubmitting=containerSel.hasClass("is--transitioning")&&containerSel.hasClass("is--submitting")&&!this.isHidden(transitionSel)&&this.isHidden(messageSel)&&this.isHidden(instructionsSel)&&this.isHidden(fieldsSel)&&this.isHidden(actionsSel),hasSubmitted=containerSel.hasClass("is--submitted")&&this.isHidden(transitionSel)&&!this.isHidden(messageSel)&&this.isHidden(instructionsSel)&&this.isHidden(fieldsSel)&&this.isHidden(actionsSel);if(!containerSel.hasClass("is--submitted")&&!containerSel.hasClass("is--transitioning")&&!containerSel.hasClass("is--submitting")&&this.isHidden(transitionSel)&&this.isHidden(messageSel)&&!this.isHidden(instructionsSel)&&!this.isHidden(fieldsSel)&&!this.isHidden(actionsSel))return"open";if(isSubmitting)return"submitting";if(hasSubmitted)return"submitted";throw"Invalid feedback state"}"open"===newState?(containerSel.toggleClass("is--transitioning",!1),containerSel.toggleClass("is--submitting",!1),containerSel.toggleClass("is--submitted",!1),this.setHidden(instructionsSel,!1),this.setHidden(fieldsSel,!1),this.setHidden(actionsSel,!1),this.setHidden(transitionSel,!0),this.setHidden(messageSel,!0)):"submitting"===newState?(containerSel.toggleClass("is--transitioning",!0),containerSel.toggleClass("is--submitting",!0),containerSel.toggleClass("is--submitted",!1),this.setHidden(instructionsSel,!0),this.setHidden(fieldsSel,!0),this.setHidden(actionsSel,!0),this.setHidden(transitionSel,!1),this.setHidden(messageSel,!0)):"submitted"===newState&&(containerSel.toggleClass("is--transitioning",!1),containerSel.toggleClass("is--submitting",!1),containerSel.toggleClass("is--submitted",!0),this.setHidden(instructionsSel,!0),this.setHidden(fieldsSel,!0),this.setHidden(actionsSel,!0),this.setHidden(transitionSel,!0),this.setHidden(messageSel,!1))},submitFeedbackOnAssessment:function(){var view=this,baseView=this.baseView;$(".feedback__submit",this.element).prop("disabled",!0),view.feedbackState("submitting"),this.server.submitFeedbackOnAssessment(this.feedbackText(),this.feedbackOptions()).done(function(){view.feedbackState("submitted")}).fail(function(errMsg){baseView.toggleActionError("feedback_assess",errMsg)})}},OpenAssessment.LeaderboardView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView},OpenAssessment.LeaderboardView.prototype={load:function(usageID){var view=this,baseView=this.baseView,stepID=".step--leaderboard";this.server.render("leaderboard").done(function(html){$(stepID,view.element).replaceWith(html),view.server.renderLatex($(stepID,view.element)),view.installHandlers(),void 0!==usageID&&$(stepID,view.element).hasClass("is--showing")&&$("[id='oa_leaderboard_"+usageID+"']",view.element).focus()}).fail(function(errMsg){baseView.showLoadError("leaderboard",errMsg)})},installHandlers:function(){this.baseView.setUpCollapseExpand($(".step--leaderboard",this.element))}},OpenAssessment.MessageView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView},OpenAssessment.MessageView.prototype={load:function(){var view=this,baseView=this.baseView;this.server.render("message").done(function(html){$(".openassessment__message",view.element).replaceWith(html),view.server.renderLatex($(".openassessment__message",view.element))}).fail(function(errMsg){baseView.showLoadError("message",errMsg)})}},OpenAssessment.PeerView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.rubric=null,this.isRendering=!1,this.announceStatus=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.PeerView.prototype={UNSAVED_WARNING_KEY:"peer-assessment",load:function(usageID){var view=this,stepID=".step--peer-assessment",focusID="[id='oa_peer_"+usageID+"']";view.isRendering=!0,this.server.render("peer_assessment").done(function(html){$(stepID,view.element).replaceWith(html),view.isRendering=!1,view.server.renderLatex($(stepID,view.element)),view.installHandlers(!1),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.announceStatus=!1,view.dateFactory.apply()}).fail(function(){view.baseView.showLoadError("peer-assessment")}),view.baseView.loadMessageView()},loadContinuedAssessment:function(usageID){var view=this,focusID="[id='oa_peer_"+usageID+"']";view.continueAssessmentEnabled(!1),view.isRendering=!0,this.server.renderContinuedPeer().done(function(html){$(".step--peer-assessment",view.element).replaceWith(html),view.server.renderLatex($(".step--peer-assessment",view.element)),view.isRendering=!1,view.installHandlers(!0),view.baseView.announceStatusChangeToSRandFocus(".step--peer-assessment",usageID,!1,view,focusID)}).fail(function(){view.baseView.showLoadError("peer-assessment"),view.continueAssessmentEnabled(!0)})},continueAssessmentEnabled:function(enabled){return this.baseView.buttonEnabled(".action--continue--grading",enabled)},installHandlers:function(isContinuedAssessment){var sel=$(".step--peer-assessment",this.element),view=this;this.baseView.setUpCollapseExpand(sel),this.baseView.bindLatexPreview(sel);var rubricSelector=$(".peer-assessment--001__assessment",this.element);if(0<rubricSelector.size()){var rubricElement=rubricSelector.get(0);this.rubric=new OpenAssessment.Rubric(rubricElement)}else this.rubric=null;null!==this.rubric&&(this.rubric.canSubmitCallback($.proxy(view.peerSubmitEnabled,view)),this.rubric.changesExistCallback($.proxy(view.assessmentRubricChanges,view))),sel.find(".peer-assessment--001__assessment__submit").click(function(eventObject){eventObject.preventDefault(),view.announceStatus=!0,isContinuedAssessment?view.continuedPeerAssess():view.peerAssess()}),sel.find(".action--continue--grading").click(function(eventObject){eventObject.preventDefault(),view.loadContinuedAssessment(view.baseView.getUsageID())})},peerSubmitEnabled:function(enabled){return this.baseView.buttonEnabled(".peer-assessment--001__assessment__submit",enabled)},assessmentRubricChanges:function(changesExist){changesExist&&this.baseView.unsavedWarningEnabled(!0,this.UNSAVED_WARNING_KEY,gettext("If you leave this page without submitting your peer assessment, you will lose any work you have done."))},peerAssess:function(){var view=this,baseView=view.baseView,usageID=baseView.getUsageID();this.peerAssessRequest(function(){baseView.unsavedWarningEnabled(!1,view.UNSAVED_WARNING_KEY),baseView.loadAssessmentModules(usageID),baseView.scrollToTop(".step--peer-assessment")})},continuedPeerAssess:function(){var view=this,gradeView=this.baseView.gradeView,baseView=view.baseView,usageID=baseView.getUsageID();view.peerAssessRequest(function(){baseView.unsavedWarningEnabled(!1,view.UNSAVED_WARNING_KEY),view.loadContinuedAssessment(usageID),gradeView.load(),baseView.scrollToTop(".step--peer-assessment")})},peerAssessRequest:function(successFunction){var view=this,uuid=this.getUUID();view.baseView.toggleActionError("peer",null),view.peerSubmitEnabled(!1),this.server.peerAssess(this.rubric.optionsSelected(),this.rubric.criterionFeedback(),this.rubric.overallFeedback(),uuid).done(successFunction).fail(function(errMsg){view.baseView.toggleActionError("peer",errMsg),view.peerSubmitEnabled(!0)})},getUUID:function(){return $("div[data-usage-id='"+this.baseView.getUsageID()+"']").find(".step--peer-assessment").data("submission-uuid")}},OpenAssessment.ResponseView=function(element,server,fileUploader,baseView,data){this.element=element,this.server=server,this.fileUploader=fileUploader,this.baseView=baseView,this.savedResponse=[],this.textResponse="required",this.fileUploadResponse="",this.files=null,this.filesDescriptions=[],this.filesType=null,this.lastChangeTime=Date.now(),this.errorOnLastSave=!1,this.autoSaveTimerId=null,this.data=data,this.filesUploaded=!1,this.announceStatus=!1,this.isRendering=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.ResponseView.prototype={AUTO_SAVE_POLL_INTERVAL:2e3,AUTO_SAVE_WAIT:3e4,MAX_FILES_SIZE:10485760,UNSAVED_WARNING_KEY:"learner-response",load:function(usageID){var view=this,stepID=".step--response",focusID="[id='oa_response_"+usageID+"']";view.isRendering=!0,this.server.render("submission").done(function(html){$(stepID,view.element).replaceWith(html),view.server.renderLatex($(stepID,view.element)),view.installHandlers(),view.setAutoSaveEnabled(!0),view.isRendering=!1,view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.announceStatus=!1,view.dateFactory.apply()}).fail(function(){view.baseView.showLoadError("response")})},installHandlers:function(){var sel=$(".step--response",this.element),view=this,uploadType="";sel.find(".submission__answer__display__file").length&&(uploadType=sel.find(".submission__answer__display__file").data("upload-type")),this.baseView.setUpCollapseExpand(sel),this.savedResponse=this.response();sel.find(".submission__answer__part__text__value").on("change keyup drop paste",function(){view.handleResponseChanged()});sel.find("input[type=file]").on("change",function(eventData){view.prepareUpload(eventData.target.files,uploadType)});var submit=$(".step--response__submit",this.element);this.textResponse=$(submit).attr("text_response"),this.fileUploadResponse=$(submit).attr("file_upload_response"),sel.find(".step--response__submit").click(function(eventObject){eventObject.preventDefault(),view.submit()}),sel.find(".submission__save").click(function(eventObject){eventObject.preventDefault(),view.save()}),this.baseView.bindLatexPreview(sel),sel.find(".file__upload").click(function(eventObject){eventObject.preventDefault();var previouslyUploadedFiles=!!sel.find(".submission__answer__file").length;if($(".submission__answer__display__file",view.element).removeClass("is--hidden"),view.hasAllUploadFiles())if(previouslyUploadedFiles){var msg=gettext("After you upload new files all your previously uploaded files will be overwritten. Continue?");confirm(msg)&&view.uploadFiles()}else view.uploadFiles()})},setAutoSaveEnabled:function(enabled){enabled?null===this.autoSaveTimerId&&(this.autoSaveTimerId=setInterval($.proxy(this.autoSave,this),this.AUTO_SAVE_POLL_INTERVAL)):null!==this.autoSaveTimerId&&clearInterval(this.autoSaveTimerId)},checkSubmissionAbility:function(filesFiledIsNotBlank){var textFieldsIsNotBlank=!this.response().every(function(element){return""===$.trim(element)});filesFiledIsNotBlank=filesFiledIsNotBlank||!1,$(".submission__answer__file",this.element).each(function(){"IMG"===$(this).prop("tagName")&&""!==$(this).attr("src")&&(filesFiledIsNotBlank=!0),"A"===$(this).prop("tagName")&&""!==$(this).attr("href")&&(filesFiledIsNotBlank=!0)});var readyToSubmit=!0;"required"!==this.textResponse||textFieldsIsNotBlank||(readyToSubmit=!1),"required"!==this.fileUploadResponse||filesFiledIsNotBlank||(readyToSubmit=!1),"optional"!==this.textResponse||"optional"!==this.fileUploadResponse||textFieldsIsNotBlank||filesFiledIsNotBlank||(readyToSubmit=!1),this.submitEnabled(readyToSubmit)},checkSaveAbility:function(){var textFieldsIsNotBlank=!this.response().every(function(element){return""===$.trim(element)});return!("required"===this.textResponse&&!textFieldsIsNotBlank)},submitEnabled:function(enabled){return this.baseView.buttonEnabled(".step--response__submit",enabled)},saveEnabled:function(enabled){return this.baseView.buttonEnabled(".submission__save",enabled)},previewEnabled:function(enabled){return this.baseView.buttonEnabled(".submission__preview",enabled)},hasPendingUploadFiles:function(){return null!==this.files&&!this.filesUploaded},hasAllUploadFiles:function(){for(var i=0;i<this.files.length;i++){var file=this.files[i];if(0===file.size)return this.baseView.toggleActionError("upload",gettext("Your file "+file.name+" has been deleted or path has been changed.")),this.submitEnabled(!0),!1}return!0},saveStatus:function(msg){var sel=$(".save__submission__label",this.element);if(void 0===msg)return sel.text();var label=gettext("Status of Your Response");sel.html('<span class="sr">'+_.escape(label)+":</span>\n"+msg)},response:function(texts){var sel=$(".response__submission .submission__answer__part__text__value",this.element);if(void 0===texts)return sel.map(function(){return $.trim($(this).val())}).get();sel.map(function(index){$(this).val(texts[index])})},responseChanged:function(){var savedResponse=this.savedResponse;return this.response().some(function(element,index){return element!==savedResponse[index]})},autoSave:function(){var timeSinceLastChange=Date.now()-this.lastChangeTime;this.responseChanged()&&timeSinceLastChange>this.AUTO_SAVE_WAIT&&!this.errorOnLastSave&&this.save()},handleResponseChanged:function(){if(this.checkSubmissionAbility(),this.responseChanged()){var saveAbility=this.checkSaveAbility();this.saveEnabled(saveAbility),this.previewEnabled(saveAbility),this.saveStatus(gettext("This response has not been saved.")),this.baseView.unsavedWarningEnabled(!0,this.UNSAVED_WARNING_KEY,gettext("If you leave this page without saving or submitting your response, you will lose any work you have done on the response."))}this.lastChangeTime=Date.now()},save:function(){this.errorOnLastSave=!1,this.saveStatus(gettext("Saving...")),this.baseView.toggleActionError("save",null),this.baseView.unsavedWarningEnabled(!1,this.UNSAVED_WARNING_KEY);var view=this,savedResponse=this.response();this.server.save(savedResponse).done(function(){if(view.savedResponse=savedResponse,view.checkSubmissionAbility(),view.response().every(function(element,index){return element===savedResponse[index]})){view.saveEnabled(!1);var msg=gettext("This response has been saved but not submitted.");view.saveStatus(msg),view.baseView.srReadTexts([msg])}}).fail(function(errMsg){view.saveStatus(gettext("Error")),view.baseView.toggleActionError("save",errMsg),view.errorOnLastSave=!0})},submit:function(){this.submitEnabled(!1);var view=this,baseView=this.baseView,fileDefer=$.Deferred();if(view.hasPendingUploadFiles()){if(!view.hasAllUploadFiles())return;var msg=gettext("Do you want to upload your file before submitting?");if(confirm(msg)&&!1===(fileDefer=view.uploadFiles()))return}else fileDefer.resolve();fileDefer.pipe(function(){return view.confirmSubmission().pipe(function(){var submission=view.response();return baseView.toggleActionError("response",null),view.server.submit(submission)})}).done($.proxy(view.moveToNextStep,view)).fail(function(errCode,errMsg){"ENOMULTI"===errCode?view.moveToNextStep():(errMsg&&baseView.toggleActionError("submit",errMsg),view.submitEnabled(!0))})},moveToNextStep:function(){var baseView=this.baseView,usageID=baseView.getUsageID();this.load(usageID),baseView.loadAssessmentModules(usageID),this.announceStatus=!0,baseView.unsavedWarningEnabled(!1,this.UNSAVED_WARNING_KEY)},confirmSubmission:function(){var msg=gettext("You're about to submit your response for this assignment. After you submit this response, you can't change it or submit a new response.");return $.Deferred(function(defer){confirm(msg)?defer.resolve():defer.reject()})},prepareUpload:function(files,uploadType,descriptions){this.files=null,this.filesType=uploadType;for(var totalSize=0,ext=null,fileType=null,errorCheckerTriggered=this.filesUploaded=!1,i=0;i<files.length;i++){if(totalSize+=files[i].size,ext=files[i].name.split(".").pop().toLowerCase(),fileType=files[i].type,files[i].name,totalSize>this.MAX_FILES_SIZE){this.baseView.toggleActionError("upload",gettext("File size must be 10MB or less.")),errorCheckerTriggered=!0;break}if("image"===uploadType&&-1===this.data.ALLOWED_IMAGE_MIME_TYPES.indexOf(fileType)){this.baseView.toggleActionError("upload",gettext("You can upload files with these file types: ")+"JPG, PNG or GIF"),errorCheckerTriggered=!0;break}if("pdf-and-image"===uploadType&&-1===this.data.ALLOWED_FILE_MIME_TYPES.indexOf(fileType)){this.baseView.toggleActionError("upload",gettext("You can upload files with these file types: ")+"JPG, PNG, GIF or PDF"),errorCheckerTriggered=!0;break}if("custom"===uploadType&&-1===this.data.FILE_TYPE_WHITE_LIST.indexOf(ext)){this.baseView.toggleActionError("upload",gettext("You can upload files with these file types: ")+this.data.FILE_TYPE_WHITE_LIST.join(", ")),errorCheckerTriggered=!0;break}if(-1!==this.data.FILE_EXT_BLACK_LIST.indexOf(ext)){this.baseView.toggleActionError("upload",gettext("File type is not allowed.")),errorCheckerTriggered=!0;break}}errorCheckerTriggered||(this.baseView.toggleActionError("upload",null),0<files.length&&(this.files=files),this.updateFilesDescriptionsFields(files,descriptions,uploadType)),null===this.files&&$(this.element).find(".file__upload").prop("disabled",!0)},updateFilesDescriptionsFields:function(files,descriptions,uploadType){var filesDescriptions=$(this.element).find(".files__descriptions").first(),mainDiv=null,divLabel=null,divTextarea=null,divImage=null,img=null,textarea=null,descriptionsExists=!0;this.filesDescriptions=descriptions||[],$(filesDescriptions).show().html("");for(var i=0;i<files.length;i++)mainDiv=$("<div/>"),(divLabel=$("<div/>")).addClass("submission__file__description__label"),divLabel.text(gettext("Describe ")+files[i].name+" "+gettext("(required):")),divLabel.appendTo(mainDiv),(divTextarea=$("<div/>")).addClass("submission__file__description"),textarea=$("<textarea />",{"aria-label":gettext("Describe ")+files[i].name}),-1!==this.filesDescriptions.indexOf(i)&&""!==this.filesDescriptions[i]?textarea.val(this.filesDescriptions[i]):descriptionsExists=!1,textarea.addClass("file__description file__description__"+i),textarea.appendTo(divTextarea),"image"===uploadType&&((img=$("<img/>",{src:window.URL.createObjectURL(files[i]),height:80,alt:gettext("Thumbnail view of ")+files[i].name})).onload=function(){window.URL.revokeObjectURL(this.src)},(divImage=$("<div/>")).addClass("submission__img__preview"),img.appendTo(divImage),divImage.appendTo(mainDiv)),divTextarea.appendTo(mainDiv),mainDiv.appendTo(filesDescriptions),textarea.on("change keyup drop paste",$.proxy(this,"checkFilesDescriptions"));$(this.element).find(".file__upload").prop("disabled",!descriptionsExists)},checkFilesDescriptions:function(){var isError=!1,filesDescriptions=[];$(this.element).find(".file__description").each(function(){var filesDescriptionVal=$.trim($(this).val());filesDescriptionVal?filesDescriptions.push(filesDescriptionVal):isError=!0}),$(this.element).find(".file__upload").prop("disabled",isError),isError||(this.filesDescriptions=filesDescriptions)},removeFilesDescriptions:function(){var filesDescriptions=$(this.element).find(".files__descriptions").first();$(filesDescriptions).hide().html("")},removeUploadedFiles:function(){var view=this,sel=$(".step--response",this.element);return this.server.removeUploadedFiles().done(function(){$(".step--response",view.element).find(".submission__answer__files").html("")}).fail(function(errMsg){view.baseView.toggleActionError("upload",errMsg),sel.find(".file__upload").prop("disabled",!1)})},saveFilesDescriptions:function(){var view=this,sel=$(".step--response",this.element);return this.server.saveFilesDescriptions(this.filesDescriptions).done(function(){view.removeFilesDescriptions()}).fail(function(errMsg){view.baseView.toggleActionError("upload",errMsg),sel.find(".file__upload").prop("disabled",!1)})},uploadFiles:function(){var view=this,promise=null,fileCount=view.files.length;return $(".step--response",this.element).find(".file__upload").prop("disabled",!0),promise=(promise=view.removeUploadedFiles()).then(function(){return view.saveFilesDescriptions()}),$.each(view.files,function(index,file){promise=promise.then(function(){return view.fileUpload(view,file.type,file.name,index,file,fileCount===index+1)})}),promise},fileUpload:function(view,filetype,filename,filenum,file,finalUpload){var sel=$(".step--response",this.element),handleError=function(errMsg){view.baseView.toggleActionError("upload",errMsg),sel.find(".file__upload").prop("disabled",!1)};return view.server.getUploadUrl(filetype,filename,filenum).done(function(url){view.fileUploader.upload(url,file).done(function(){view.fileUrl(filenum),view.baseView.toggleActionError("upload",null),finalUpload&&(sel.find("input[type=file]").val(""),view.filesUploaded=!0,view.checkSubmissionAbility(!0))}).fail(handleError)}).fail(handleError)},fileUrl:function(filenum){var view=this,sel=$(".step--response",this.element);view.server.getDownloadUrl(filenum).done(function(url){var className="submission__answer__file__block__"+filenum,file=null,img=null,fileBlock=null,div1=null,div2=null,ariaLabelledBy=null;return!!sel.find("."+className).length||((fileBlock=$("<div/>")).addClass("submission__answer__file__block "+className),fileBlock.appendTo(sel.find(".submission__answer__files").first())),"image"===view.filesType?(ariaLabelledBy="file_description_"+Math.random().toString(36).substr(2,9),(div1=$("<div/>",{id:ariaLabelledBy})).addClass("submission__file__description__label"),div1.text(view.filesDescriptions[filenum]+":"),div1.appendTo(fileBlock),(img=$("<img />")).addClass("submission__answer__file submission--image"),img.attr("aria-labelledby",ariaLabelledBy),img.attr("src",url),(div2=$("<div/>")).html(img),div2.appendTo(fileBlock)):((file=$("<a />",{href:url,text:view.filesDescriptions[filenum]})).addClass("submission__answer__file submission--file"),file.attr("target","_blank"),file.appendTo(fileBlock)),url})}},OpenAssessment.Rubric=function(element){this.element=element},OpenAssessment.Rubric.prototype={criterionFeedback:function(criterionFeedback){var feedback={},rubric=this;return $("textarea.answer__value",this.element).each(function(index,sel){var criterionName=rubric.getCriterionName(sel);void 0!==criterionFeedback?($(sel).val(criterionFeedback[criterionName]),feedback[criterionName]=criterionFeedback[criterionName]):feedback[criterionName]=$(sel).val()}),feedback},overallFeedback:function(overallFeedback){var selector=".assessment__rubric__question--feedback__value";if(void 0===overallFeedback)return $(selector,this.element).val();$(selector,this.element).val(overallFeedback)},optionsSelected:function(optionsSelected){var selector="input[type=radio]",rubric=this;if(void 0===optionsSelected){var options={};return $(selector+":checked",this.element).each(function(index,sel){options[rubric.getCriterionName(sel)]=sel.value}),options}$(selector,this.element).prop("checked",!1),$(selector,this.element).each(function(index,sel){var criterionName=rubric.getCriterionName(sel);optionsSelected.hasOwnProperty(criterionName)&&sel.value===optionsSelected[criterionName]&&$(sel).prop("checked",!0)})},canSubmitCallback:function(callback){var rubric=this;callback(rubric.canSubmit()),$(this.element).on("change keyup drop paste",function(){callback(rubric.canSubmit())})},canSubmit:function(){var numChecked=$("input[type=radio]:checked",this.element).length,numAvailable=$(".field--radio.assessment__rubric__question.has--options",this.element).length,completedRequiredComments=!0;return $("textarea[required]",this.element).each(function(){""===$.trim($(this).val())&&(completedRequiredComments=!1)}),numChecked===numAvailable&&completedRequiredComments},changesExistCallback:function(callback){var rubric=this;callback(rubric.changesExist()),$(this.element).on("change keyup drop paste",function(){callback(rubric.changesExist())})},changesExist:function(){var numChecked=$("input[type=radio]:checked",this.element).length,textExists=!1;return $("textarea",this.element).each(function(){""!==$.trim($(this).val())&&(textExists=!0)}),0<numChecked||textExists},showCorrections:function(corrections){var hasErrors=!1,rubric=this;return $("input[type=radio]",this.element).each(function(index,sel){var listItem=$(sel).parents(".assessment__rubric__question");corrections.hasOwnProperty(rubric.getCriterionName(sel))?(hasErrors=!0,listItem.find(".message--incorrect").removeClass("is--hidden"),listItem.find(".message--correct").addClass("is--hidden")):(listItem.find(".message--correct").removeClass("is--hidden"),listItem.find(".message--incorrect").addClass("is--hidden"))}),hasErrors},getCriterionName:function(element){return $(element).data("criterion-name")}},OpenAssessment.SelfView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.rubric=null,this.isRendering=!1,this.announceStatus=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.SelfView.prototype={UNSAVED_WARNING_KEY:"self-assessment",load:function(usageID){var view=this,stepID=".step--self-assessment",focusID="[id='oa_self_"+usageID+"']";view.isRendering=!0,this.server.render("self_assessment").done(function(html){$(stepID,view.element).replaceWith(html),view.isRendering=!1,view.server.renderLatex($(stepID,view.element)),view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.dateFactory.apply()}).fail(function(){view.showLoadError("self-assessment")})},installHandlers:function(){var view=this,sel=$(".step--self-assessment",view.element);this.baseView.setUpCollapseExpand(sel),this.baseView.bindLatexPreview(sel);var rubricSelector=$(".self-assessment--001__assessment",this.element);if(0<rubricSelector.size()){var rubricElement=rubricSelector.get(0);this.rubric=new OpenAssessment.Rubric(rubricElement)}else this.rubric=null;null!==this.rubric&&(this.rubric.canSubmitCallback($.proxy(this.selfSubmitEnabled,this)),this.rubric.changesExistCallback($.proxy(this.assessmentRubricChanges,this))),sel.find(".self-assessment--001__assessment__submit").click(function(eventObject){eventObject.preventDefault(),view.selfAssess()})},selfSubmitEnabled:function(enabled){return this.baseView.buttonEnabled(".self-assessment--001__assessment__submit",enabled)},assessmentRubricChanges:function(changesExist){changesExist&&this.baseView.unsavedWarningEnabled(!0,this.UNSAVED_WARNING_KEY,gettext("If you leave this page without submitting your self assessment, you will lose any work you have done."))},selfAssess:function(){var view=this,baseView=this.baseView,usageID=baseView.getUsageID();baseView.toggleActionError("self",null),view.selfSubmitEnabled(!1),this.server.selfAssess(this.rubric.optionsSelected(),this.rubric.criterionFeedback(),this.rubric.overallFeedback()).done(function(){baseView.unsavedWarningEnabled(!1,view.UNSAVED_WARNING_KEY),view.announceStatus=!0,baseView.loadAssessmentModules(usageID)}).fail(function(errMsg){baseView.toggleActionError("self",errMsg),view.selfSubmitEnabled(!0)})}},OpenAssessment.StaffView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.isRendering=!1,this.announceStatus=!1},OpenAssessment.StaffView.prototype={load:function(usageID){var view=this,focusID="[id='oa_staff_grade_"+usageID+"']";view.isRendering=!0,this.server.render("staff_assessment").done(function(html){$(".step--staff-assessment",view.element).replaceWith(html),view.isRendering=!1,view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(".step--staff-assessment",usageID,!1,view,focusID)}).fail(function(){view.baseView.showLoadError("staff-assessment")})},installHandlers:function(){this.baseView.setUpCollapseExpand($(".step--staff-assessment",this.element))}},function(OpenAssessment){"use strict";OpenAssessment.StaffAreaView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView},OpenAssessment.StaffAreaView.prototype={FULL_GRADE_UNSAVED_WARNING_KEY:"staff-grade",OVERRIDE_UNSAVED_WARNING_KEY:"staff-override",load:function(){var view=this;0<$(".openassessment__staff-area",view.element).length&&this.server.render("staff_area").done(function(html){$(".openassessment__staff-area",view.element).replaceWith(html),view.server.renderLatex($(".openassessment__staff-area",view.element)),view.installHandlers()}).fail(function(){view.baseView.showLoadError("staff_area")})},loadStudentInfo:function(classToExpand){var view=this,$manageLearnersTab=$(".openassessment__staff-tools",this.element),$form=$manageLearnersTab.find(".openassessment_student_info_form"),studentUsername=$manageLearnersTab.find(".openassessment__student_username").val(),showFormError=function(errorMessage){$form.find(".form--error").text(errorMessage).focus()},deferred=$.Deferred();return $(".openassessment__student-info",view.element).text(""),studentUsername.trim()?this.server.studentInfo(studentUsername).done(function(html){showFormError(""),$(".openassessment__student-info",view.element).replaceWith(html),$manageLearnersTab.on("click",".action--submit-cancel-submission",function(eventObject){eventObject.preventDefault(),view.cancelSubmission($(this).data("submission-uuid"))});$manageLearnersTab.find(".cancel_submission_comments").on("change keyup drop paste",function(eventData){view.handleCommentChanged(eventData)});var $rubric=$manageLearnersTab.find(".staff-assessment__assessment");if(0<$rubric.size()){var rubricElement=$rubric.get(0),rubric=new OpenAssessment.Rubric(rubricElement);rubric.canSubmitCallback($.proxy(view.staffSubmitEnabled,view,$manageLearnersTab)),rubric.changesExistCallback($.proxy(view.assessmentRubricChanges,view,view.OVERRIDE_UNSAVED_WARNING_KEY)),$manageLearnersTab.find(".wrapper--staff-assessment .action--submit",view.element).click(function(eventObject){var submissionID=$(eventObject.currentTarget).closest(".openassessment__student-info").data("submission-uuid");eventObject.preventDefault(),view.submitStaffOverride(submissionID,rubric,$manageLearnersTab)})}view.baseView.setUpCollapseExpand($manageLearnersTab),$manageLearnersTab.find(".staff-info__student__report__summary").focus(),classToExpand&&($manageLearnersTab.find("."+classToExpand+" ."+view.baseView.SLIDABLE_CONTENT_CLASS).slideDown(),$manageLearnersTab.find("."+classToExpand+" ."+view.baseView.SLIDABLE_CLASS).addClass(view.baseView.IS_SHOWING_CLASS).attr("aria-expanded","true").focus()),deferred.resolve()}).fail(function(){showFormError(gettext("Unexpected server error.")),deferred.reject()}):(showFormError(gettext("You must provide a learner name.")),deferred.reject()),deferred.promise()},loadStaffGradeForm:function(){var view=this,$staffGradeTab=$(".openassessment__staff-grading",this.element),$staffGradeControl=$staffGradeTab.find("."+view.baseView.SLIDABLE_CLASS),$staffGradeContent=$staffGradeTab.find("."+view.baseView.SLIDABLE_CONTENT_CLASS),$staffGradeContainer=$staffGradeTab.find("."+view.baseView.SLIDABLE_CONTAINER_CLASS),deferred=$.Deferred(),showFormError=function(errorMessage){$staffGradeTab.find(".staff__grade__form--error").text(errorMessage).focus()};return $staffGradeControl.attr("aria-expanded","true"),this.staffGradeFormLoaded?($staffGradeContent.slideDown(),$staffGradeContainer.addClass(view.baseView.IS_SHOWING_CLASS),deferred.resolve()):(this.staffGradeFormLoaded=!0,this.server.staffGradeForm().done(function(html){showFormError(""),$staffGradeTab.find(".staff__grade__form").replaceWith(html),view.updateStaffGradeCounts();var $rubric=$staffGradeTab.find(".staff-assessment__assessment");if(0<$rubric.size()){var rubricElement=$rubric.get(0),rubric=new OpenAssessment.Rubric(rubricElement);rubric.canSubmitCallback($.proxy(view.staffSubmitEnabled,view,$staffGradeTab)),rubric.changesExistCallback($.proxy(view.assessmentRubricChanges,view,view.FULL_GRADE_UNSAVED_WARNING_KEY)),$staffGradeTab.find(".wrapper--staff-assessment .action--submit").click(function(eventObject){var submissionID=$staffGradeTab.find(".staff__grade__form").data("submission-uuid");eventObject.preventDefault(),view.submitStaffGrade(submissionID,rubric,$staffGradeTab,$(eventObject.currentTarget).hasClass("continue_grading--action"))})}$staffGradeContent.slideDown(function(){$staffGradeControl.focus(),view.baseView.setUpCollapseExpand($(".staff__grade__form",view.element))}),$staffGradeContainer.addClass(view.baseView.IS_SHOWING_CLASS),deferred.resolve()}).fail(function(){showFormError(gettext("Unexpected server error.")),view.staffGradeFormLoaded=!1,deferred.reject()})),deferred.promise()},closeStaffGradeForm:function(clear){var $staffGradeTab=$(".openassessment__staff-grading",this.element),$staffGradeControl=$staffGradeTab.find("."+this.baseView.SLIDABLE_CLASS).first(),$staffGradeContent=$staffGradeTab.find("."+this.baseView.SLIDABLE_CONTENT_CLASS),$staffGradeContainer=$staffGradeTab.find("."+this.baseView.SLIDABLE_CONTAINER_CLASS);$staffGradeControl.attr("aria-expanded","false"),clear?($staffGradeTab.find(".staff__grade__form").replaceWith('<div class="staff__grade__form"></div>'),this.updateStaffGradeCounts()):$staffGradeContent.slideUp(),$staffGradeContainer.removeClass(this.baseView.IS_SHOWING_CLASS),$staffGradeControl.focus()},updateStaffGradeCounts:function(){var $staffGradeTab=$(".openassessment__staff-grading",this.element);this.server.staffGradeCounts().done(function(html){$staffGradeTab.find(".staff__grade__status").replaceWith(html)}).fail(function(){$staffGradeTab.find(".staff__grade__status").replaceWith('<span class="staff__grade__status"><span class="staff__grade__value"><span class="copy">'+gettext("Error getting the number of ungraded responses")+"</span></span></span>")})},installHandlers:function(){var view=this,$staffArea=$(".openassessment__staff-area",this.element),$manageLearnersTab=$(".openassessment__staff-tools",$staffArea),$staffGradeTool=$(".openassessment__staff-grading",$staffArea);$staffArea.length<=0||($staffArea.find(".ui-staff__button").click(function(eventObject){$staffArea.find(".ui-staff__button").each(function(index,button){button!==eventObject.currentTarget&&$staffArea.find("."+$(button).data("panel")).first().slideUp(0)});var $button=$(eventObject.currentTarget),$panel=$staffArea.find("."+$button.data("panel")).first();$button.hasClass("is--active")?($button.removeClass("is--active").attr("aria-expanded","false"),$panel.slideUp()):($staffArea.find(".ui-staff__button").removeClass("is--active").attr("aria-expanded","false"),$button.addClass("is--active").attr("aria-expanded","true"),$panel.slideDown()),$panel.find(".ui-staff_close_button").focus()}),$staffArea.find(".ui-staff_close_button").click(function(eventObject){var $panel=$(eventObject.currentTarget).closest(".wrapper--ui-staff");$staffArea.find(".ui-staff__button").removeClass("is--active").attr("aria-expanded","false"),$panel.slideUp(),$staffArea.find(".ui-staff__button").each(function(index,button){$staffArea.find("."+$(button).data("panel")).first()[0]===$panel[0]&&$(button).focus()})}),$manageLearnersTab.find(".openassessment_student_info_form").submit(function(eventObject){eventObject.preventDefault(),view.loadStudentInfo()}),$manageLearnersTab.find(".action--submit-username").click(function(eventObject){eventObject.preventDefault(),view.loadStudentInfo()}),$manageLearnersTab.find(".action--submit-training").click(function(eventObject){eventObject.preventDefault(),view.scheduleTraining()}),$manageLearnersTab.find(".action--submit-unfinished-tasks").click(function(eventObject){eventObject.preventDefault(),view.rescheduleUnfinishedTasks()}),$staffGradeTool.find(".staff__grade__show-form").click(function(event){$(event.currentTarget).closest("."+view.baseView.SLIDABLE_CONTAINER_CLASS).hasClass(view.baseView.IS_SHOWING_CLASS)?view.closeStaffGradeForm(!1):view.loadStaffGradeForm()}))},scheduleTraining:function(){var view=this;this.server.scheduleTraining().done(function(msg){$(".schedule_training_message",view.element).text(msg)}).fail(function(errMsg){$(".schedule_training_message",view.element).text(errMsg)})},rescheduleUnfinishedTasks:function(){var view=this;this.server.rescheduleUnfinishedTasks().done(function(msg){$(".reschedule_unfinished_tasks_message",view.element).text(msg)}).fail(function(errMsg){$(".reschedule_unfinished_tasks_message",view.element).text(errMsg)})},cancelSubmission:function(submissionUUID){this.cancelSubmissionEnabled(!1);var view=this,comments=$(".cancel_submission_comments",this.element).val();this.server.cancelSubmission(submissionUUID,comments).done(function(){view.loadStudentInfo("staff-info__student__grade")}).fail(function(errorMessage){$(".cancel-submission-error").html(_.escape(errorMessage))})},cancelSubmissionEnabled:function(enabled){return this.baseView.buttonEnabled(".action--submit-cancel-submission",enabled)},comment:function(text){var $submissionComments=$(".cancel_submission_comments",this.element);if(void 0===text)return $submissionComments.val();$submissionComments.val(text)},handleCommentChanged:function(){var isBlank=""!==$.trim(this.comment());this.cancelSubmissionEnabled(isBlank)},staffSubmitEnabled:function(scope,enabled){return this.baseView.buttonEnabled(".wrapper--staff-assessment .action--submit",enabled)},assessmentRubricChanges:function(key,changesExist){changesExist&&this.baseView.unsavedWarningEnabled(!0,key,gettext("If you leave this page without submitting your staff assessment, you will lose any work you have done."))},submitStaffOverride:function(submissionID,rubric,scope){var view=this;this.callStaffAssess(submissionID,rubric,scope,function(){view.baseView.unsavedWarningEnabled(!1,view.OVERRIDE_UNSAVED_WARNING_KEY),view.loadStudentInfo("staff-info__student__grade")},".staff-override-error","regrade")},submitStaffGrade:function(submissionID,rubric,scope,continueGrading){var view=this;this.callStaffAssess(submissionID,rubric,scope,function(){view.baseView.unsavedWarningEnabled(!1,view.FULL_GRADE_UNSAVED_WARNING_KEY),view.staffGradeFormLoaded=!1,continueGrading?(view.loadStaffGradeForm(),view.baseView.scrollToTop(".openassessment__staff-area")):view.closeStaffGradeForm(!0)},".staff-grade-error","full-grade")},callStaffAssess:function(submissionID,rubric,scope,successCallback,errorSelector,assessType){var view=this;view.staffSubmitEnabled(scope,!1),this.server.staffAssess(rubric.optionsSelected(),rubric.criterionFeedback(),rubric.overallFeedback(),submissionID,assessType).done(successCallback).fail(function(errorMessage){scope.find(errorSelector).html(_.escape(errorMessage)),view.staffSubmitEnabled(scope,!0)})}}}(OpenAssessment),OpenAssessment.StudentTrainingView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.rubric=null,this.isRendering=!1,this.announceStatus=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.StudentTrainingView.prototype={load:function(usageID){var view=this,stepID=".step--student-training",focusID="[id='oa_training_"+usageID+"']";view.isRendering=!0,this.server.render("student_training").done(function(html){$(stepID,view.element).replaceWith(html),view.isRendering=!1,view.server.renderLatex($(stepID,view.element)),view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.announceStatus=!1,view.dateFactory.apply()}).fail(function(){view.baseView.showLoadError("student-training")})},installHandlers:function(){var sel=$(".step--student-training",this.element),view=this;this.baseView.setUpCollapseExpand(sel);var rubricSelector=$(".student-training--001__assessment",this.element);if(0<rubricSelector.size()){var rubricElement=rubricSelector.get(0);this.rubric=new OpenAssessment.Rubric(rubricElement)}null!==this.rubric&&this.rubric.canSubmitCallback($.proxy(this.assessButtonEnabled,this)),sel.find(".student-training--001__assessment__submit").click(function(eventObject){eventObject.preventDefault(),view.assess(),view.announceStatus=!0})},assess:function(){this.assessButtonEnabled(!1);var options={};null!==this.rubric&&(options=this.rubric.optionsSelected());var view=this,baseView=this.baseView,usageID=baseView.getUsageID();this.server.trainingAssess(options).done(function(corrections){var incorrect=$(".openassessment__student-training--incorrect",view.element),instructions=$(".openassessment__student-training--instructions",view.element),$questionAnswers=$(".question__answers",view.rubric.element);view.rubric.showCorrections(corrections)?(instructions.addClass("is--hidden"),incorrect.removeClass("is--hidden"),$questionAnswers.each(function(index,answer){var $notification=$(".step__message.message",view.rubric.element).not(".is--hidden");$(answer).attr("aria-describedby",$($notification[index]).attr("id"))}),baseView.srReadTexts([gettext("Feedback available for selection.")])):(view.load(usageID),baseView.loadAssessmentModules(usageID),incorrect.addClass("is--hidden"),instructions.removeClass("is--hidden")),baseView.scrollToTop(".step--student-training")}).fail(function(errMsg){baseView.toggleActionError("student-training",errMsg),view.assessButtonEnabled(!0)})},assessButtonEnabled:function(isEnabled){return this.baseView.buttonEnabled(".student-training--001__assessment__submit",isEnabled)}},function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return a.Backgrid=b(c,d)}):"object"==typeof exports?module.exports=b(require("underscore"),require("backbone")):a.Backgrid=b(a._,a.Backbone)}(this,function(a,b){"use strict";function c(a,b,c){var d=b-(a+"").length;d=d<0?0:d;for(var e="",f=0;f<d;f++)e+=c;return e+a}var d="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff";if(!String.prototype.trim||d.trim()){d="["+d+"]";var e=new RegExp("^"+d+d+"*"),f=new RegExp(d+d+"*$");String.prototype.trim=function(){if(null==this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(e,"").replace(f,"")}}var g=b.$,h={Extension:{},resolveNameToClass:function(b,c){if(a.isString(b)){var d=a.map(b.split("-"),function(a){return a.slice(0,1).toUpperCase()+a.slice(1)}).join("")+c,e=h[d]||h.Extension[d];if(a.isUndefined(e))throw new ReferenceError("Class '"+d+"' not found");return e}return b},callByNeed:function(){var b=arguments[0];if(!a.isFunction(b))return b;var c=arguments[1],d=[].slice.call(arguments,2);return b.apply(c,d+""?d:[])}};a.extend(h,b.Events);var i=h.Command=function(b){a.extend(this,{altKey:!!b.altKey,char:b.char,charCode:b.charCode,ctrlKey:!!b.ctrlKey,key:b.key,keyCode:b.keyCode,locale:b.locale,location:b.location,metaKey:!!b.metaKey,repeat:!!b.repeat,shiftKey:!!b.shiftKey,which:b.which})};a.extend(i.prototype,{moveUp:function(){return 38==this.keyCode},moveDown:function(){return 40===this.keyCode},moveLeft:function(){return this.shiftKey&&9===this.keyCode},moveRight:function(){return!this.shiftKey&&9===this.keyCode},save:function(){return 13===this.keyCode},cancel:function(){return 27===this.keyCode},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var j=h.CellFormatter=function(){};a.extend(j.prototype,{fromRaw:function(a,b){return a},toRaw:function(a,b){return a}});var k=h.NumberFormatter=function(b){if(a.extend(this,this.defaults,b||{}),this.decimals<0||20<this.decimals)throw new RangeError("decimals must be between 0 and 20")};k.prototype=new j,a.extend(k.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(b,c){if(a.isNull(b)||a.isUndefined(b))return"";var d=(b=parseFloat(b).toFixed(~~this.decimals)).split("."),e=d[0],f=d[1]?(this.decimalSeparator||".")+d[1]:"";return e.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+f},toRaw:function(b,c){if(""===(b=b.trim()))return null;for(var d="",e=b.split(this.orderSeparator),f=0;f<e.length;f++)d+=e[f];var g=d.split(this.decimalSeparator);d="";for(f=0;f<g.length;f++)d=d+g[f]+".";"."===d[d.length-1]&&(d=d.slice(0,d.length-1));var h=1*(1*d).toFixed(~~this.decimals);return a.isNumber(h)&&!a.isNaN(h)?h:void 0}});var l=h.PercentFormatter=function(){h.NumberFormatter.apply(this,arguments)};l.prototype=new h.NumberFormatter,a.extend(l.prototype,{defaults:a.extend({},k.prototype.defaults,{multiplier:1,symbol:"%"}),fromRaw:function(a,b){var c=[].slice.call(arguments,1);return c.unshift(a*this.multiplier),(k.prototype.fromRaw.apply(this,c)||"0")+this.symbol},toRaw:function(b,c){var d=b.split(this.symbol);if(d&&d[0]&&""===d[1]||null==d[1]){var e=k.prototype.toRaw.call(this,d[0]);return a.isUndefined(e)?e:e/this.multiplier}}});var m=h.DatetimeFormatter=function(b){if(a.extend(this,this.defaults,b||{}),!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};m.prototype=new j,a.extend(m.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(b,d){if(""===(b+"").trim())return null;var e,f=null;if(a.isNumber(b)){e=c((g=new Date(b)).getUTCFullYear(),4,0)+"-"+c(g.getUTCMonth()+1,2,0)+"-"+c(g.getUTCDate(),2,0),f=c(g.getUTCHours(),2,0)+":"+c(g.getUTCMinutes(),2,0)+":"+c(g.getUTCSeconds(),2,0)}else{var h=(b=b.trim()).split(this.ISO_SPLITTER_RE)||[];f=(e=this.DATE_RE.test(h[0])?h[0]:"")&&h[1]?h[1]:this.TIME_RE.test(h[0])?h[0]:""}var i=this.DATE_RE.exec(e)||[],j=this.TIME_RE.exec(f)||[];if(d){if(this.includeDate&&a.isUndefined(i[0]))return;if(this.includeTime&&a.isUndefined(j[0]))return;if(!this.includeDate&&e)return;if(!this.includeTime&&f)return}var g=new Date(Date.UTC(1*i[1]||0,1*i[2]-1||0,1*i[3]||0,1*j[1]||null,1*j[2]||null,1*j[3]||null,1*j[5]||null)),k="";return this.includeDate&&(k=c(g.getUTCFullYear(),4,0)+"-"+c(g.getUTCMonth()+1,2,0)+"-"+c(g.getUTCDate(),2,0)),this.includeTime&&(k=k+(this.includeDate?"T":"")+c(g.getUTCHours(),2,0)+":"+c(g.getUTCMinutes(),2,0)+":"+c(g.getUTCSeconds(),2,0),this.includeMilli&&(k=k+"."+c(g.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(k+="Z"),k},fromRaw:function(b,c){return a.isNull(b)||a.isUndefined(b)?"":this._convert(b)},toRaw:function(a,b){return this._convert(a,!0)}});var n=h.StringFormatter=function(){};n.prototype=new j,a.extend(n.prototype,{fromRaw:function(b,c){return a.isUndefined(b)||a.isNull(b)?"":b+""}});var o=h.EmailFormatter=function(){};o.prototype=new j,a.extend(o.prototype,{toRaw:function(b,c){var d=b.trim().split("@");if(2===d.length&&a.all(d))return b}});var p=h.SelectFormatter=function(){};p.prototype=new j,a.extend(p.prototype,{fromRaw:function(b,c){return a.isArray(b)?b:null!=b?[b]:[]}});var q=h.CellEditor=b.View.extend({initialize:function(a){this.formatter=a.formatter,this.column=a.column,this.column instanceof B||(this.column=new B(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(a,b){return null!=b&&b.get("name")!=this.column.get("name")||this.$el.focus(),this}}),r=h.InputCellEditor=q.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(a){r.__super__.initialize.apply(this,arguments),a.placeholder&&this.$el.attr("placeholder",a.placeholder)},render:function(){var a=this.model;return this.$el.val(this.formatter.fromRaw(a.get(this.column.get("name")),a)),this},saveOrCancel:function(b){var c=this.formatter,d=this.model,e=this.column,f=new i(b),g="blur"===b.type;if(f.moveUp()||f.moveDown()||f.moveLeft()||f.moveRight()||f.save()||g){b.preventDefault(),b.stopPropagation();var h=this.$el.val(),j=c.toRaw(h,d);a.isUndefined(j)?d.trigger("backgrid:error",d,e,h):(d.set(e.get("name"),j),d.trigger("backgrid:edited",d,e,f))}else f.cancel()&&(b.stopPropagation(),d.trigger("backgrid:edited",d,e,f))},postRender:function(a,b){if(null==b||b.get("name")==this.column.get("name"))if("right"===this.$el.css("text-align")){var c=this.$el.val();this.$el.focus().val(null).val(c)}else this.$el.focus();return this}}),s=h.Cell=b.View.extend({tagName:"td",formatter:j,editor:r,events:{click:"enterEditMode"},initialize:function(b){this.column=b.column,this.column instanceof B||(this.column=new B(this.column));var c=this.column,d=this.model,e=this.$el,f=h.resolveNameToClass(c.get("formatter")||this.formatter,"Formatter");a.isFunction(f.fromRaw)||a.isFunction(f.toRaw)||(f=new f),this.formatter=f,this.editor=h.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(d,"change:"+c.get("name"),function(){e.hasClass("editor")||this.render()}),this.listenTo(d,"backgrid:error",this.renderError),this.listenTo(c,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var c in b)b.hasOwnProperty(c)&&e.toggleClass(c,b[c])}),this.updateStateClassesMaybe()},updateStateClassesMaybe:function(){var a=this.model,b=this.column,c=this.$el;c.toggleClass("editable",h.callByNeed(b.editable(),b,a)),c.toggleClass("sortable",h.callByNeed(b.sortable(),b,a)),c.toggleClass("renderable",h.callByNeed(b.renderable(),b,a))},render:function(){var a=this.$el;a.empty();var b=this.model,c=this.column.get("name");return a.text(this.formatter.fromRaw(b.get(c),b)),a.addClass(c),this.updateStateClassesMaybe(),this.delegateEvents(),this},enterEditMode:function(){var a=this.model,b=this.column;h.callByNeed(b.editable(),b,a)&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),a.trigger("backgrid:edit",a,b,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),a.trigger("backgrid:editing",a,b,this,this.currentEditor))},renderError:function(a,b){null!=b&&b.get("name")!=this.column.get("name")||this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),s.__super__.remove.apply(this,arguments)}}),t=h.StringCell=s.extend({className:"string-cell",formatter:n}),u=h.UriCell=s.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(a){u.__super__.initialize.apply(this,arguments),this.title=a.title||this.title,this.target=a.target||this.target},render:function(){this.$el.empty();var a=this.model.get(this.column.get("name")),b=this.formatter.fromRaw(a,this.model);return this.$el.append(g("<a>",{tabIndex:-1,href:a,title:this.title||b,target:this.target}).text(b)),this.delegateEvents(),this}}),v=(h.EmailCell=t.extend({className:"email-cell",formatter:o,render:function(){this.$el.empty();var a=this.model,b=this.formatter.fromRaw(a.get(this.column.get("name")),a);return this.$el.append(g("<a>",{tabIndex:-1,href:"mailto:"+b,title:b}).text(b)),this.delegateEvents(),this}}),h.NumberCell=s.extend({className:"number-cell",decimals:k.prototype.defaults.decimals,decimalSeparator:k.prototype.defaults.decimalSeparator,orderSeparator:k.prototype.defaults.orderSeparator,formatter:k,initialize:function(a){v.__super__.initialize.apply(this,arguments);var b=this.formatter;b.decimals=this.decimals,b.decimalSeparator=this.decimalSeparator,b.orderSeparator=this.orderSeparator}})),w=(h.IntegerCell=v.extend({className:"integer-cell",decimals:0}),h.PercentCell=v.extend({className:"percent-cell",multiplier:l.prototype.defaults.multiplier,symbol:l.prototype.defaults.symbol,formatter:l,initialize:function(){w.__super__.initialize.apply(this,arguments);var a=this.formatter;a.multiplier=this.multiplier,a.symbol=this.symbol}})),x=h.DatetimeCell=s.extend({className:"datetime-cell",includeDate:m.prototype.defaults.includeDate,includeTime:m.prototype.defaults.includeTime,includeMilli:m.prototype.defaults.includeMilli,formatter:m,initialize:function(b){x.__super__.initialize.apply(this,arguments);var c=this.formatter;c.includeDate=this.includeDate,c.includeTime=this.includeTime,c.includeMilli=this.includeMilli;var d=this.includeDate?"YYYY-MM-DD":"";d+=this.includeDate&&this.includeTime?"T":"",d+=this.includeTime?"HH:mm:ss":"",d+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:a.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:d})})}}),y=(h.DateCell=x.extend({className:"date-cell",includeTime:!1}),h.TimeCell=x.extend({className:"time-cell",includeDate:!1}),h.BooleanCellEditor=q.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var a=this.model,b=this.formatter.fromRaw(a.get(this.column.get("name")),a);return this.$el.prop("checked",b),this},enterOrExitEditMode:function(a){if(!this.mouseDown){var b=this.model;b.trigger("backgrid:edited",b,this.column,new i(a))}},saveOrCancel:function(a){var b=this.model,c=this.column,d=this.formatter,e=new i(a);if(e.passThru()&&"change"!=a.type)return!0;e.cancel()&&(a.stopPropagation(),b.trigger("backgrid:edited",b,c,e));var f=this.$el;if(e.save()||e.moveLeft()||e.moveRight()||e.moveUp()||e.moveDown()){a.preventDefault(),a.stopPropagation();var g=d.toRaw(f.prop("checked"),b);b.set(c.get("name"),g),b.trigger("backgrid:edited",b,c,e)}else if("change"==a.type){g=d.toRaw(f.prop("checked"),b);b.set(c.get("name"),g),f.focus()}}})),z=(h.BooleanCell=s.extend({className:"boolean-cell",editor:y,events:{click:"enterEditMode"},render:function(){this.$el.empty();var a=this.model,b=this.column,c=h.callByNeed(b.editable(),b,a);return this.$el.append(g("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(a.get(b.get("name")),a),disabled:!c})),this.delegateEvents(),this}}),h.SelectCellEditor=q.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:a.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>',null,{variable:null,evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g}),setOptionValues:function(b){this.optionValues=b,this.optionValues=a.result(this,"optionValues")},setMultiple:function(a){this.multiple=a,this.$el.prop("multiple",a)},_renderOptions:function(b,c){for(var d="",e=0;e<b.length;e++)d+=this.template({text:b[e][0],value:b[e][1],selected:-1<a.indexOf(c,b[e][1])});return d},render:function(){this.$el.empty();var b=a.result(this,"optionValues"),c=this.model,d=this.formatter.fromRaw(c.get(this.column.get("name")),c);if(!a.isArray(b))throw new TypeError("optionValues must be an array");for(var e=null,f=null,h=(e=null,null),i=null,j=0;j<b.length;j++){e=b[j];if(a.isArray(e))f=e[0],e=e[1],this.$el.append(this.template({text:f,value:e,selected:-1<a.indexOf(d,e)}));else{if(!a.isObject(e))throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");h=e.name,(i=g("<optgroup></optgroup>",{label:h})).append(this._renderOptions.call(this,e.values,d)),this.$el.append(i)}}return this.delegateEvents(),this},save:function(a){var b=this.model,c=this.column;b.set(c.get("name"),this.formatter.toRaw(this.$el.val(),b))},close:function(a){var b=this.model,c=this.column,d=new i(a);d.cancel()?(a.stopPropagation(),b.trigger("backgrid:edited",b,c,new i(a))):(d.save()||d.moveLeft()||d.moveRight()||d.moveUp()||d.moveDown()||"blur"==a.type)&&(a.preventDefault(),a.stopPropagation(),this.save(a),b.trigger("backgrid:edited",b,c,new i(a)))}})),A=h.SelectCell=s.extend({className:"select-cell",editor:z,multiple:!1,formatter:p,optionValues:void 0,delimiter:", ",initialize:function(a){A.__super__.initialize.apply(this,arguments),this.listenTo(this.model,"backgrid:edit",function(a,b,c,d){b.get("name")==this.column.get("name")&&(d.setOptionValues(this.optionValues),d.setMultiple(this.multiple))})},render:function(){this.$el.empty();var b=a.result(this,"optionValues"),c=this.model,d=this.formatter.fromRaw(c.get(this.column.get("name")),c),e=[];try{if(!a.isArray(b)||a.isEmpty(b))throw new TypeError;for(var f=0;f<d.length;f++)for(var g=d[f],h=0;h<b.length;h++){var i=b[h];if(a.isArray(i)){var j=i[0];(i=i[1])==g&&e.push(j)}else{if(!a.isObject(i))throw new TypeError;for(var k=i.values,l=0;l<k.length;l++){var m=k[l];m[1]==g&&e.push(m[0])}}}this.$el.append(e.join(this.delimiter))}catch(a){if(a instanceof TypeError)throw new TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw a}return this.delegateEvents(),this}}),B=h.Column=b.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,sortType:"cycle",sortValue:void 0,direction:null,cell:void 0,headerCell:void 0},initialize:function(){this.has("label")||this.set({label:this.get("name")},{silent:!0});var a=h.resolveNameToClass(this.get("headerCell"),"HeaderCell"),b=h.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:b,headerCell:a},{silent:!0})},sortValue:function(){var b=this.get("sortValue");return a.isString(b)?this[b]:a.isFunction(b)?b:function(a,b){return a.get(b)}}});a.each(["sortable","renderable","editable"],function(b){B.prototype[b]=function(){var c=this.get(b);return a.isString(c)?this[c]:a.isFunction(c)?c:!!c}});var C=h.Columns=b.Collection.extend({model:B}),D=h.Row=b.View.extend({tagName:"tr",initialize:function(a){var c=this.columns=a.columns;c instanceof b.Collection||(c=this.columns=new C(c));for(var d=this.cells=[],e=0;e<c.length;e++)d.push(this.makeCell(c.at(e),a));this.listenTo(c,"add",function(b,c){var e=c.indexOf(b),f=this.makeCell(b,a);d.splice(e,0,f);var g=this.$el;0===e?g.prepend(f.render().$el):e===c.length-1?g.append(f.render().$el):g.children().eq(e).before(f.render().$el)}),this.listenTo(c,"remove",function(a,b,c){d[c.index].remove(),d.splice(c.index,1)})},makeCell:function(a){return new(a.get("cell"))({column:a,model:this.model})},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.cells.length;b++)a.appendChild(this.cells[b].render().el);return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.cells.length;a++){var c=this.cells[a];c.remove.apply(c,arguments)}return b.View.prototype.remove.apply(this,arguments)}}),E=h.EmptyRow=b.View.extend({tagName:"tr",emptyText:null,initialize:function(a){this.emptyText=a.emptyText,this.columns=a.columns},render:function(){this.$el.empty();var b=document.createElement("td");b.setAttribute("colspan",this.columns.length);var c=document.createElement("span");return c.innerHTML=a.result(this,"emptyText"),b.appendChild(c),this.el.className="empty",this.el.appendChild(b),this}}),F=h.HeaderCell=b.View.extend({tagName:"th",events:{"click button":"onClick"},initialize:function(a){this.column=a.column,this.column instanceof B||(this.column=new B(this.column));var b=this.column,c=this.collection,d=this.$el;this.listenTo(b,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var c in b)b.hasOwnProperty(c)&&d.toggleClass(c,b[c])}),this.listenTo(b,"change:direction",this.setCellDirection),this.listenTo(b,"change:name change:label",this.render),h.callByNeed(b.editable(),b,c)&&d.addClass("editable"),h.callByNeed(b.sortable(),b,c)&&d.addClass("sortable"),h.callByNeed(b.renderable(),b,c)&&d.addClass("renderable"),this.listenTo(c.fullCollection||c,"backgrid:sorted",this.removeCellDirection)},removeCellDirection:function(){this.$el.removeClass("ascending").removeClass("descending"),this.column.set("direction",null)},setCellDirection:function(a,b){this.$el.removeClass("ascending").removeClass("descending"),a.cid==this.column.cid&&this.$el.addClass(b)},onClick:function(a){a.preventDefault();var d=this.column,e=this.collection,f="backgrid:sort";h.callByNeed(d.sortable(),d,this.collection)&&("toggle"===d.get("sortType")?function(a,b){"ascending"===d.get("direction")?e.trigger(f,b,"descending"):e.trigger(f,b,"ascending")}(0,d):function(a,b){"ascending"===d.get("direction")?e.trigger(f,b,"descending"):"descending"===d.get("direction")?e.trigger(f,b,null):e.trigger(f,b,"ascending")}(0,d))},render:function(){this.$el.empty();var a,b=this.column;return a=h.callByNeed(b.sortable(),b,this.collection)?g("<button>").text(b.get("label")).append("<span class='sort-caret' aria-hidden='true'></span>"):document.createTextNode(b.get("label")),this.$el.append(a),this.$el.addClass(b.get("name")),this.$el.addClass(b.get("direction")),this.delegateEvents(),this}}),G=(h.HeaderRow=h.Row.extend({initialize:function(){h.Row.prototype.initialize.apply(this,arguments)},makeCell:function(a,b){var c=a.get("headerCell")||b.headerCell||F;return new c({column:a,collection:this.collection})}}),h.Header=b.View.extend({tagName:"thead",initialize:function(a){this.columns=a.columns,this.columns instanceof b.Collection||(this.columns=new C(this.columns)),this.row=new h.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),b.View.prototype.remove.apply(this,arguments)}})),H=h.Body=b.View.extend({tagName:"tbody",initialize:function(a){this.columns=a.columns,this.columns instanceof b.Collection||(this.columns=new C(this.columns)),this.row=a.row||this.row||D,this.rows=this.collection.map(function(a){return new this.row({columns:this.columns,model:a})},this),this.emptyText=a.emptyText,this._unshiftEmptyRowMayBe();var c=this.collection;this.listenTo(c,"add",this.insertRow),this.listenTo(c,"remove",this.removeRow),this.listenTo(c,"sort",this.refresh),this.listenTo(c,"reset",this.refresh),this.listenTo(c,"backgrid:sort",this.sort),this.listenTo(c,"backgrid:edited",this.moveToNextCell),this.listenTo(this.columns,"add remove",this.updateEmptyRow)},_unshiftEmptyRowMayBe:function(){if(0===this.rows.length&&null!=this.emptyText)return this.emptyRow=new E({emptyText:this.emptyText,columns:this.columns}),this.rows.unshift(this.emptyRow),!0},insertRow:function(a,c,d){if(this.rows[0]instanceof E&&this.rows.pop().remove(),c instanceof b.Collection||d){var e=new this.row({columns:this.columns,model:a}),f=c.indexOf(a);this.rows.splice(f,0,e);var g=this.$el,h=g.children(),i=e.render().$el;return f>=h.length?g.append(i):h.eq(f).before(i),this}this.collection.add(a,d=c)},removeRow:function(b,c,d){return d?((a.isUndefined(d.render)||d.render)&&this.rows[d.index].remove(),this.rows.splice(d.index,1),this._unshiftEmptyRowMayBe()&&this.render(),this):(this.collection.remove(b,d=c),void(this._unshiftEmptyRowMayBe()&&this.render()))},updateEmptyRow:function(){null!=this.emptyRow&&this.emptyRow.render()},refresh:function(){for(var a=0;a<this.rows.length;a++)this.rows[a].remove();return this.rows=this.collection.map(function(a){return new this.row({columns:this.columns,model:a})},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.rows.length;b++){var c=this.rows[b];a.appendChild(c.render().el)}return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.rows.length;a++){var c=this.rows[a];c.remove.apply(c,arguments)}return b.View.prototype.remove.apply(this,arguments)},sort:function(c,d){if(!a.contains(["ascending","descending",null],d))throw new RangeError('direction must be one of "ascending", "descending" or `null`');a.isString(c)&&(c=this.columns.findWhere({name:c}));var e,f=this.collection;e="ascending"===d?-1:"descending"===d?1:null;var g=this.makeComparator(c.get("name"),e,e?c.sortValue():function(a){return 1*a.cid.replace("c","")});return b.PageableCollection&&f instanceof b.PageableCollection?(f.setSorting(e&&c.get("name"),e,{sortValue:c.sortValue()}),f.fullCollection?(null==f.fullCollection.comparator&&(f.fullCollection.comparator=g),f.fullCollection.sort(),f.trigger("backgrid:sorted",c,d,f),c.set("direction",d)):f.fetch({reset:!0,success:function(){f.trigger("backgrid:sorted",c,d,f),c.set("direction",d)}})):(f.comparator=g,f.sort(),f.trigger("backgrid:sorted",c,d,f),c.set("direction",d)),this},makeComparator:function(a,b,c){return function(d,e){var f,g=c(d,a),h=c(e,a);return 1===b&&(f=g,g=h,h=f),g===h?0:g<h?-1:1}},moveToNextCell:function(a,b,c){var d,e,f,g,i,j=this.collection.indexOf(a),k=this.columns.indexOf(b);if(-1===k)return this;if(this.rows[j].cells[k].exitEditMode(),c.moveUp()||c.moveDown()||c.moveLeft()||c.moveRight()||c.save()){var l=this.columns.length,m=l*this.collection.length;if(c.moveUp()||c.moveDown()){g=j+(c.moveUp()?-1:1);var n=this.rows[g];n?(d=n.cells[k],h.callByNeed(d.column.editable(),d.column,a)&&(d.enterEditMode(),a.trigger("backgrid:next",g,k,!1))):a.trigger("backgrid:next",g,k,!0)}else if(c.moveLeft()||c.moveRight()){for(var o=c.moveRight(),p=j*l+k+(o?1:-1);0<=p&&p<m;o?p++:p--)if(i=p-(g=~~(p/l))*l,d=this.rows[g].cells[i],e=h.callByNeed(d.column.renderable(),d.column,d.model),f=h.callByNeed(d.column.editable(),d.column,a),e&&f){d.enterEditMode(),a.trigger("backgrid:next",g,i,!1);break}p==m&&a.trigger("backgrid:next",~~(p/l),p-g*l,!0)}}return this}});return h.Footer=b.View.extend({tagName:"tfoot",initialize:function(a){this.columns=a.columns,this.columns instanceof b.Collection||(this.columns=new h.Columns(this.columns))}}),h.Grid=b.View.extend({tagName:"table",className:"backgrid",header:G,body:H,footer:null,initialize:function(c){c.columns instanceof b.Collection||(c.columns=new C(c.columns||this.columns)),this.columns=c.columns,this.caption=c.caption;var d=a.omit(c,["el","id","attributes","className","tagName","events"]);this.body=c.body||this.body,this.body=new this.body(d),this.header=c.header||this.header,this.header&&(this.header=new this.header(d)),this.footer=c.footer||this.footer,this.footer&&(this.footer=new this.footer(d)),this.listenTo(this.columns,"reset",function(){this.header&&(this.header=new(this.header.remove().constructor)(d)),this.body=new(this.body.remove().constructor)(d),this.footer&&(this.footer=new(this.footer.remove().constructor)(d)),this.render()})},insertRow:function(){return this.body.insertRow.apply(this.body,arguments),this},removeRow:function(){return this.body.removeRow.apply(this.body,arguments),this},insertColumn:function(){return this.columns.add.apply(this.columns,arguments),this},removeColumn:function(){return this.columns.remove.apply(this.columns,arguments),this},sort:function(){return this.body.sort.apply(this.body,arguments),this},render:function(){return this.$el.empty(),this.caption&&this.$el.append(g("<caption>").text(this.caption)),this.header&&this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header&&this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),b.View.prototype.remove.apply(this,arguments)}}),h});
