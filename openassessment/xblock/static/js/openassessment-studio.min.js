function OpenAssessmentEditor(runtime,element,data){var server=new OpenAssessment.Server(runtime,element);new OpenAssessment.StudioView(runtime,element,server,data)}if("undefined"!=typeof OpenAssessment&&OpenAssessment||(OpenAssessment={}),void 0===window.gettext&&(window.gettext=function(text){return text}),void 0===window.ngetgext&&(window.ngettext=function(singularText,pluralText,n){return n>1?pluralText:singularText}),void 0===window.Logger&&(window.Logger={log:function(){}}),void 0===window.MathJax&&(window.MathJax={Hub:{Typeset:function(){},Queue:function(){}}}),void 0===OpenAssessment.Server||!OpenAssessment.Server){OpenAssessment.Server=function(runtime,element){this.runtime=runtime,this.element=element};var jsonContentType="application/json; charset=utf-8";OpenAssessment.Server.prototype={url:function(handler){return this.runtime.handlerUrl(this.element,handler)},render:function(component){var view=this,url=this.url("render_"+component);return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(view,[data])}).fail(function(){defer.rejectWith(view,[gettext("This section could not be loaded.")])})}).promise()},renderLatex:function(element){element.filter(".allow--latex").each(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,this])})},renderContinuedPeer:function(){var view=this,url=this.url("render_peer_assessment");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html",data:{continue_grading:!0}}).done(function(data){defer.resolveWith(view,[data])}).fail(function(){defer.rejectWith(view,[gettext("This section could not be loaded.")])})}).promise()},studentInfo:function(studentUsername,options){var url=this.url("render_student_info");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html",data:_.extend({student_username:studentUsername},options)}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("This section could not be loaded.")])})}).promise()},staffGradeForm:function(){var url=this.url("render_staff_grade_form");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("The staff assessment form could not be loaded.")])})}).promise()},staffGradeCounts:function(){var url=this.url("render_staff_grade_counts");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("The display of ungraded and checked out responses could not be loaded.")])})}).promise()},submit:function(submission){var url=this.url("submit");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({submission:submission}),contentType:jsonContentType}).done(function(data){if(data[0]){var studentId=data[1],attemptNum=data[2];defer.resolveWith(this,[studentId,attemptNum])}else{var errorNum=data[1],errorMsg=data[2];defer.rejectWith(this,[errorNum,errorMsg])}}).fail(function(){defer.rejectWith(this,["AJAX",gettext("This response could not be submitted.")])})}).promise()},save:function(submission){var url=this.url("save_submission");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({submission:submission}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This response could not be saved.")])})}).promise()},submitFeedbackOnAssessment:function(text,options){var url=this.url("submit_feedback"),payload=JSON.stringify({feedback_text:text,feedback_options:options});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This feedback could not be submitted.")])})}).promise()},submitAssessment:function(assessmentType,payload){var url=this.url(assessmentType);return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify(payload),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})}).promise()},peerAssess:function(optionsSelected,criterionFeedback,overallFeedback,submissionID){return this.submitAssessment("peer_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback,submission_uuid:submissionID})},selfAssess:function(optionsSelected,criterionFeedback,overallFeedback){return this.submitAssessment("self_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback})},staffAssess:function(optionsSelected,criterionFeedback,overallFeedback,submissionID,assessType){return this.submitAssessment("staff_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback,submission_uuid:submissionID,assess_type:assessType})},trainingAssess:function(optionsSelected){var url=this.url("training_assess"),payload=JSON.stringify({options_selected:optionsSelected});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.corrections]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})})},scheduleTraining:function(){var url=this.url("schedule_training");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.msg]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})})},rescheduleUnfinishedTasks:function(){var url=this.url("reschedule_unfinished_tasks");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.msg]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("One or more rescheduling tasks failed.")])})})},updateEditorContext:function(options){var url=this.url("update_editor_context"),payload=JSON.stringify({prompts:options.prompts,feedback_prompt:options.feedbackPrompt,feedback_default_text:options.feedback_default_text,title:options.title,submission_start:options.submissionStart,submission_due:options.submissionDue,criteria:options.criteria,assessments:options.assessments,editor_assessments_order:options.editorAssessmentsOrder,text_response:options.textResponse,file_upload_response:options.fileUploadResponse,file_upload_type:options.fileUploadType,white_listed_file_types:options.fileTypeWhiteList,allow_latex:options.latexEnabled,leaderboard_show:options.leaderboardNum});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This problem could not be saved.")])})}).promise()},checkReleased:function(){var url=this.url("check_released");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.is_released]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("The server could not be contacted.")])})}).promise()},getUploadUrl:function(contentType,filename,filenum){var url=this.url("upload_url");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({contentType:contentType,filename:filename,filenum:filenum}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve(data.url):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Could not retrieve upload url.")])})}).promise()},removeUploadedFiles:function(){var url=this.url("remove_all_uploaded_files");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Server error.")])})}).promise()},saveFilesDescriptions:function(descriptions){var url=this.url("save_files_descriptions");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({descriptions:descriptions}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Server error.")])})}).promise()},getDownloadUrl:function(filenum){var url=this.url("download_url");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({filenum:filenum}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve(data.url):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Could not retrieve download url.")])})}).promise()},cancelSubmission:function(submissionID,comments){var url=this.url("cancel_submission"),payload=JSON.stringify({submission_uuid:submissionID,comments:comments});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success&&defer.resolveWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("The submission could not be removed from the grading pool.")])})}).promise()},publishEvent:function(eventName,eventData){eventData.event_name=eventName;var url=this.url("publish_event"),payload=JSON.stringify(eventData);$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType})}}}OpenAssessment.Container=function(ContainerItem,kwargs){this.containerElement=kwargs.containerElement,this.templateElement=kwargs.templateElement,this.addButtonElement=kwargs.addButtonElement,this.removeButtonClass=kwargs.removeButtonClass,this.containerItemClass=kwargs.containerItemClass,this.notifier=kwargs.notifier,this.addRemoveEnabled=void 0===kwargs.addRemoveEnabled||kwargs.addRemoveEnabled;var container=this;this.createContainerItem=function(element){return new ContainerItem(element,container.notifier)}},OpenAssessment.Container.prototype={addEventListeners:function(){var container=this;this.addRemoveEnabled?($(this.addButtonElement).click($.proxy(this.add,this)),$("."+this.removeButtonClass,this.containerElement).click(function(eventData){var item=container.createContainerItem(eventData.target);container.remove(item)})):($(this.addButtonElement).addClass("is--disabled"),$("."+this.removeButtonClass,this.containerElement).addClass("is--disabled")),$("."+this.containerItemClass,this.containerElement).each(function(index,element){container.createContainerItem(element).addEventListeners()})},add:function(){$(this.templateElement).children().first().clone().removeAttr("id").toggleClass("is--hidden",!1).toggleClass(this.containerItemClass,!0).appendTo($(this.containerElement));var container=this,containerItem=$("."+this.containerItemClass,this.containerElement).last();this.addRemoveEnabled?containerItem.find("."+this.removeButtonClass).click(function(eventData){var containerItem=container.createContainerItem(eventData.target);container.remove(containerItem)}):containerItem.find("."+this.removeButtonClass).addClass("is--disabled");var handlerItem=container.createContainerItem(containerItem);handlerItem.addEventListeners(),handlerItem.addHandler()},remove:function(item){var itemElement=$(item.element).closest("."+this.containerItemClass);this.createContainerItem(itemElement).removeHandler(),itemElement.remove()},getItemValues:function(){var values=[],container=this;return $("."+this.containerItemClass,this.containerElement).each(function(index,element){var fieldValues=container.createContainerItem(element).getFieldValues();values.push(fieldValues)}),values},getItem:function(index){var element=$("."+this.containerItemClass,this.containerElement).get(index);return void 0!==element?this.createContainerItem(element):null},getAllItems:function(){var container=this;return $("."+this.containerItemClass,this.containerElement).map(function(){return container.createContainerItem(this)})}},OpenAssessment.ItemUtilities={createUniqueName:function(selector,nameAttribute){for(var index=0;index<=selector.length;){if(0===selector.parent().find("*["+nameAttribute+"='"+index+"']").length)return index.toString();index++}return index.toString()},refreshOptionString:function(element){var points=$(element).attr("data-points"),label=$(element).attr("data-label"),name=$(element).val();""===label&&(label=gettext("Unnamed Option"));var singularString=label+" - "+points+" point",multipleString=label+" - "+points+" points",finalLabel="";finalLabel=""===name?gettext("Not Selected"):isNaN(points)?label:ngettext(singularString,multipleString,points),$(element).text(finalLabel)}},OpenAssessment.Prompt=function(element,notifier){this.element=element,this.notifier=notifier},OpenAssessment.Prompt.prototype={getFieldValues:function(){return{description:this.description()}},description:function(text){var sel=$(".openassessment_prompt_description",this.element);return OpenAssessment.Fields.stringField(sel,text)},addEventListeners:function(){},addHandler:function(){this.notifier.notificationFired("promptAdd",{index:this.element.index()})},removeHandler:function(){this.notifier.notificationFired("promptRemove",{index:this.element.index()})},updateHandler:function(){},validate:function(){return!0},validationErrors:function(){return[]},clearValidationErrors:function(){}},OpenAssessment.RubricOption=function(element,notifier){this.element=element,this.notifier=notifier,this.pointsField=new OpenAssessment.IntField($(".openassessment_criterion_option_points",this.element),{min:0,max:999})},OpenAssessment.RubricOption.prototype={addEventListeners:function(){$(this.element).focusout($.proxy(this.updateHandler,this))},getFieldValues:function(){var fields={label:this.label(),points:this.points(),explanation:this.explanation()},nameString=OpenAssessment.Fields.stringField($(".openassessment_criterion_option_name",this.element));return""!==nameString&&(fields.name=nameString),fields},label:function(label){var sel=$(".openassessment_criterion_option_label",this.element);return OpenAssessment.Fields.stringField(sel,label)},points:function(points){return void 0!==points&&this.pointsField.set(points),this.pointsField.get()},explanation:function(explanation){var sel=$(".openassessment_criterion_option_explanation",this.element);return OpenAssessment.Fields.stringField(sel,explanation)},addHandler:function(){var criterionElement=$(this.element).closest(".openassessment_criterion"),criterionName=$(criterionElement).data("criterion"),criterionLabel=$(".openassessment_criterion_label",criterionElement).val(),options=$(".openassessment_criterion_option",this.element.parent()),name=OpenAssessment.ItemUtilities.createUniqueName(options,"data-option");$(this.element).attr("data-criterion",criterionName).attr("data-option",name),$(".openassessment_criterion_option_name",this.element).attr("value",name);var fields=this.getFieldValues();this.notifier.notificationFired("optionAdd",{criterionName:criterionName,criterionLabel:criterionLabel,name:name,label:fields.label,points:fields.points})},removeHandler:function(){var criterionName=$(this.element).data("criterion"),optionName=$(this.element).data("option");this.notifier.notificationFired("optionRemove",{criterionName:criterionName,name:optionName})},updateHandler:function(){var fields=this.getFieldValues(),criterionName=$(this.element).data("criterion"),optionName=$(this.element).data("option"),optionLabel=fields.label,optionPoints=fields.points;this.notifier.notificationFired("optionUpdated",{criterionName:criterionName,name:optionName,label:optionLabel,points:optionPoints})},validate:function(){return this.pointsField.validate()},validationErrors:function(){return this.pointsField.validationErrors().length>0?["Option points are invalid"]:[]},clearValidationErrors:function(){this.pointsField.clearValidationErrors()}},OpenAssessment.RubricCriterion=function(element,notifier){this.element=element,this.notifier=notifier,this.labelSel=$(".openassessment_criterion_label",this.element),this.promptSel=$(".openassessment_criterion_prompt",this.element),this.optionContainer=new OpenAssessment.Container(OpenAssessment.RubricOption,{containerElement:$(".openassessment_criterion_option_list",this.element).get(0),templateElement:$("#openassessment_option_template").get(0),addButtonElement:$(".openassessment_criterion_add_option",this.element).get(0),removeButtonClass:"openassessment_criterion_option_remove_button",containerItemClass:"openassessment_criterion_option",notifier:this.notifier})},OpenAssessment.RubricCriterion.prototype={addEventListeners:function(){this.optionContainer.addEventListeners(),$(this.element).focusout($.proxy(this.updateHandler,this))},getFieldValues:function(){var fields={label:this.label(),prompt:this.prompt(),feedback:this.feedback(),options:this.optionContainer.getItemValues()},nameString=OpenAssessment.Fields.stringField($(".openassessment_criterion_name",this.element));return""!==nameString&&(fields.name=nameString),fields},label:function(label){return OpenAssessment.Fields.stringField(this.labelSel,label)},prompt:function(prompt){return OpenAssessment.Fields.stringField(this.promptSel,prompt)},feedback:function(){return $(".openassessment_criterion_feedback",this.element).val()},addOption:function(){this.optionContainer.add()},addHandler:function(){var criteria=$(".openassessment_criterion",this.element.parent()),name=OpenAssessment.ItemUtilities.createUniqueName(criteria,"data-criterion");$(this.element).attr("data-criterion",name),$(".openassessment_criterion_name",this.element).attr("value",name)},removeHandler:function(){var criterionName=$(this.element).data("criterion");this.notifier.notificationFired("criterionRemove",{criterionName:criterionName})},updateHandler:function(){var fields=this.getFieldValues(),criterionName=fields.name,criterionLabel=fields.label;this.notifier.notificationFired("criterionUpdated",{criterionName:criterionName,criterionLabel:criterionLabel})},validate:function(){var isValid=""!==this.prompt();return isValid||this.promptSel.addClass("openassessment_highlighted_field"),$.each(this.optionContainer.getAllItems(),function(){isValid=this.validate()&&isValid}),isValid},validationErrors:function(){var errors=[];return this.promptSel.hasClass("openassessment_highlighted_field")&&errors.push("Criterion prompt is invalid."),$.each(this.optionContainer.getAllItems(),function(){errors=errors.concat(this.validationErrors())}),errors},clearValidationErrors:function(){this.promptSel.removeClass("openassessment_highlighted_field"),$.each(this.optionContainer.getAllItems(),function(){this.clearValidationErrors()})}},OpenAssessment.TrainingExample=function(element){this.element=element,this.criteria=$(".openassessment_training_example_criterion_option",this.element),this.answer=$(".openassessment_training_example_essay_part textarea",this.element)},OpenAssessment.TrainingExample.prototype={getFieldValues:function(){var optionsSelected=this.criteria.map(function(){return{criterion:$(this).data("criterion"),option:$(this).prop("value")}}).get();return{answer:this.answer.map(function(){return $(this).prop("value")}).get(),options_selected:optionsSelected}},addHandler:function(){$(".openassessment_training_example_criterion_option",this.element).each(function(){$("option",this).each(function(){OpenAssessment.ItemUtilities.refreshOptionString($(this))})})},addEventListeners:function(){},removeHandler:function(){},updateHandler:function(){},validate:function(){var isValid=!0;return this.criteria.each(function(){var isOptionValid=""!==$(this).prop("value");isValid=isOptionValid&&isValid,isOptionValid||$(this).addClass("openassessment_highlighted_field")}),isValid},validationErrors:function(){var errors=[];return this.criteria.each(function(){$(this).hasClass("openassessment_highlighted_field")&&errors.push("Student training example is invalid.")}),errors},clearValidationErrors:function(){this.criteria.each(function(){$(this).removeClass("openassessment_highlighted_field")})}},OpenAssessment.StudioView=function(runtime,element,server,data){this.element=element,this.runtime=runtime,this.server=server,this.data=data,this.fixModalHeight(),this.initializeTabs(),this.alert=(new OpenAssessment.ValidationAlert).install();var studentTrainingListener=new OpenAssessment.StudentTrainingListener;this.promptsView=new OpenAssessment.EditPromptsView($("#oa_prompts_editor_wrapper",this.element).get(0),new OpenAssessment.Notifier([studentTrainingListener]));var staffAssessmentView=new OpenAssessment.EditStaffAssessmentView($("#oa_staff_assessment_editor",this.element).get(0)),studentTrainingView=new OpenAssessment.EditStudentTrainingView($("#oa_student_training_editor",this.element).get(0)),peerAssessmentView=new OpenAssessment.EditPeerAssessmentView($("#oa_peer_assessment_editor",this.element).get(0)),selfAssessmentView=new OpenAssessment.EditSelfAssessmentView($("#oa_self_assessment_editor",this.element).get(0)),assessmentLookupDictionary={};assessmentLookupDictionary[staffAssessmentView.getID()]=staffAssessmentView,assessmentLookupDictionary[studentTrainingView.getID()]=studentTrainingView,assessmentLookupDictionary[peerAssessmentView.getID()]=peerAssessmentView,assessmentLookupDictionary[selfAssessmentView.getID()]=selfAssessmentView,this.settingsView=new OpenAssessment.EditSettingsView($("#oa_basic_settings_editor",this.element).get(0),assessmentLookupDictionary,data),this.rubricView=new OpenAssessment.EditRubricView($("#oa_rubric_editor_wrapper",this.element).get(0),new OpenAssessment.Notifier([studentTrainingListener])),$(".openassessment_save_button",this.element).click($.proxy(this.save,this)),$(".openassessment_cancel_button",this.element).click($.proxy(this.cancel,this))},OpenAssessment.StudioView.prototype={fixModalHeight:function(){$(this.element).addClass("openassessment_full_height").parentsUntil(".modal-window").addClass("openassessment_full_height"),$(this.element).closest(".modal-window").addClass("openassessment_modal_window")},initializeTabs:function(){void 0===OpenAssessment.lastOpenEditingTab&&(OpenAssessment.lastOpenEditingTab=2),$(".openassessment_editor_content_and_tabs",this.element).tabs({active:OpenAssessment.lastOpenEditingTab})},saveTabState:function(){var tabElement=$(".openassessment_editor_content_and_tabs",this.element);OpenAssessment.lastOpenEditingTab=tabElement.tabs("option","active")},save:function(){var view=this;this.saveTabState(),this.clearValidationErrors(),this.validate()?(this.alert.hide(),this.server.checkReleased().done(function(isReleased){isReleased?view.confirmPostReleaseUpdate($.proxy(view.updateEditorContext,view)):view.updateEditorContext()}).fail(function(errMsg){view.showError(errMsg)})):this.alert.setMessage(gettext("Couldn't Save This Assignment"),gettext("Please correct the outlined fields.")).show()},confirmPostReleaseUpdate:function(onConfirm){var msg=gettext("This problem has already been released. Any changes will apply only to future assessments.");confirm(msg)&&onConfirm()},updateEditorContext:function(){this.runtime.notify("save",{state:"start"});var view=this,fileUploadType=view.settingsView.fileUploadType();this.server.updateEditorContext({prompts:view.promptsView.promptsDefinition(),feedbackPrompt:view.rubricView.feedbackPrompt(),feedback_default_text:view.rubricView.feedback_default_text(),criteria:view.rubricView.criteriaDefinition(),title:view.settingsView.displayName(),submissionStart:view.settingsView.submissionStart(),submissionDue:view.settingsView.submissionDue(),assessments:view.settingsView.assessmentsDescription(),textResponse:view.settingsView.textResponseNecessity(),fileUploadResponse:view.settingsView.fileUploadResponseNecessity(),fileUploadType:""!==fileUploadType?fileUploadType:null,fileTypeWhiteList:view.settingsView.fileTypeWhiteList(),latexEnabled:view.settingsView.latexEnabled(),leaderboardNum:view.settingsView.leaderboardNum(),editorAssessmentsOrder:view.settingsView.editorAssessmentsOrder()}).done(function(){view.runtime.notify("save",{state:"end"})}).fail(function(msg){view.showError(msg)})},cancel:function(){this.saveTabState(),this.runtime.notify("cancel",{})},showError:function(errorMsg){this.runtime.notify("error",{msg:errorMsg})},validate:function(){var settingsValid=this.settingsView.validate(),rubricValid=this.rubricView.validate(),promptsValid=this.promptsView.validate();return settingsValid&&rubricValid&&promptsValid},validationErrors:function(){return this.settingsView.validationErrors().concat(this.rubricView.validationErrors().concat(this.promptsView.validationErrors()))},clearValidationErrors:function(){this.settingsView.clearValidationErrors(),this.rubricView.clearValidationErrors(),this.promptsView.clearValidationErrors()}},OpenAssessment.EditPeerAssessmentView=function(element){this.element=element,this.name="peer-assessment",this.mustGradeField=new OpenAssessment.IntField($("#peer_assessment_must_grade",this.element),{min:0,max:99}),this.mustBeGradedByField=new OpenAssessment.IntField($("#peer_assessment_graded_by",this.element),{min:0,max:99}),new OpenAssessment.ToggleControl($("#include_peer_assessment",this.element),$("#peer_assessment_settings_editor",this.element),$("#peer_assessment_description_closed",this.element),new OpenAssessment.Notifier([new OpenAssessment.AssessmentToggleListener])).install(),this.startDatetimeControl=new OpenAssessment.DatetimeControl(this.element,"#peer_assessment_start_date","#peer_assessment_start_time").install(),this.dueDatetimeControl=new OpenAssessment.DatetimeControl(this.element,"#peer_assessment_due_date","#peer_assessment_due_time").install()},OpenAssessment.EditPeerAssessmentView.prototype={description:function(){return{must_grade:this.mustGradeNum(),must_be_graded_by:this.mustBeGradedByNum(),start:this.startDatetime(),due:this.dueDatetime()}},isEnabled:function(isEnabled){var sel=$("#include_peer_assessment",this.element);return OpenAssessment.Fields.booleanField(sel,isEnabled)},toggleEnabled:function(){$("#include_peer_assessment",this.element).click()},mustGradeNum:function(num){return void 0!==num&&this.mustGradeField.set(num),this.mustGradeField.get()},mustBeGradedByNum:function(num){return void 0!==num&&this.mustBeGradedByField.set(num),this.mustBeGradedByField.get()},startDatetime:function(dateString,timeString){return this.startDatetimeControl.datetime(dateString,timeString)},dueDatetime:function(dateString,timeString){return this.dueDatetimeControl.datetime(dateString,timeString)},getID:function(){return $(this.element).attr("id")},validate:function(){var startValid=this.startDatetimeControl.validate(),dueValid=this.dueDatetimeControl.validate(),mustGradeValid=this.mustGradeField.validate(),mustBeGradedByValid=this.mustBeGradedByField.validate();return startValid&&dueValid&&mustGradeValid&&mustBeGradedByValid},validationErrors:function(){var errors=[];return this.startDatetimeControl.validationErrors().length>0&&errors.push("Peer assessment start is invalid"),this.dueDatetimeControl.validationErrors().length>0&&errors.push("Peer assessment due is invalid"),this.mustGradeField.validationErrors().length>0&&errors.push("Peer assessment must grade is invalid"),this.mustBeGradedByField.validationErrors().length>0&&errors.push("Peer assessment must be graded by is invalid"),errors},clearValidationErrors:function(){this.startDatetimeControl.clearValidationErrors(),this.dueDatetimeControl.clearValidationErrors(),this.mustGradeField.clearValidationErrors(),this.mustBeGradedByField.clearValidationErrors()}},OpenAssessment.EditSelfAssessmentView=function(element){this.element=element,this.name="self-assessment",new OpenAssessment.ToggleControl($("#include_self_assessment",this.element),$("#self_assessment_settings_editor",this.element),$("#self_assessment_description_closed",this.element),new OpenAssessment.Notifier([new OpenAssessment.AssessmentToggleListener])).install(),this.startDatetimeControl=new OpenAssessment.DatetimeControl(this.element,"#self_assessment_start_date","#self_assessment_start_time").install(),this.dueDatetimeControl=new OpenAssessment.DatetimeControl(this.element,"#self_assessment_due_date","#self_assessment_due_time").install()},OpenAssessment.EditSelfAssessmentView.prototype={description:function(){return{start:this.startDatetime(),due:this.dueDatetime()}},isEnabled:function(isEnabled){var sel=$("#include_self_assessment",this.element);return OpenAssessment.Fields.booleanField(sel,isEnabled)},toggleEnabled:function(){$("#include_self_assessment",this.element).click()},startDatetime:function(dateString,timeString){return this.startDatetimeControl.datetime(dateString,timeString)},dueDatetime:function(dateString,timeString){return this.dueDatetimeControl.datetime(dateString,timeString)},getID:function(){return $(this.element).attr("id")},validate:function(){var startValid=this.startDatetimeControl.validate(),dueValid=this.dueDatetimeControl.validate();return startValid&&dueValid},validationErrors:function(){var errors=[];return this.startDatetimeControl.validationErrors().length>0&&errors.push("Self assessment start is invalid"),this.dueDatetimeControl.validationErrors().length>0&&errors.push("Self assessment due is invalid"),errors},clearValidationErrors:function(){this.startDatetimeControl.clearValidationErrors(),this.dueDatetimeControl.clearValidationErrors()}},OpenAssessment.EditStudentTrainingView=function(element){this.element=element,this.name="student-training",new OpenAssessment.ToggleControl($("#include_student_training",this.element),$("#student_training_settings_editor",this.element),$("#student_training_description_closed",this.element),new OpenAssessment.Notifier([new OpenAssessment.AssessmentToggleListener])).install(),this.exampleContainer=new OpenAssessment.Container(OpenAssessment.TrainingExample,{containerElement:$("#openassessment_training_example_list",this.element).get(0),templateElement:$("#openassessment_training_example_template",this.element).get(0),addButtonElement:$(".openassessment_add_training_example",this.element).get(0),removeButtonClass:"openassessment_training_example_remove",containerItemClass:"openassessment_training_example"}),this.exampleContainer.addEventListeners()},OpenAssessment.EditStudentTrainingView.prototype={description:function(){return{examples:this.exampleContainer.getItemValues()}},isEnabled:function(isEnabled){var sel=$("#include_student_training",this.element);return OpenAssessment.Fields.booleanField(sel,isEnabled)},toggleEnabled:function(){$("#include_student_training",this.element).click()},getID:function(){return $(this.element).attr("id")},validate:function(){var isValid=!0;return $.each(this.exampleContainer.getAllItems(),function(){isValid=this.validate()&&isValid}),isValid},validationErrors:function(){var errors=[];return $.each(this.exampleContainer.getAllItems(),function(){errors=errors.concat(this.validationErrors())}),errors},clearValidationErrors:function(){$.each(this.exampleContainer.getAllItems(),function(){this.clearValidationErrors()})},addTrainingExample:function(){this.exampleContainer.add()}},OpenAssessment.EditStaffAssessmentView=function(element){this.element=element,this.name="staff-assessment",new OpenAssessment.ToggleControl($("#include_staff_assessment",this.element),$("#staff_assessment_description",this.element),$("#staff_assessment_description",this.element),new OpenAssessment.Notifier([new OpenAssessment.AssessmentToggleListener])).install()},OpenAssessment.EditStaffAssessmentView.prototype={description:function(){return{required:this.isEnabled()}},isEnabled:function(isEnabled){var sel=$("#include_staff_assessment",this.element);return OpenAssessment.Fields.booleanField(sel,isEnabled)},toggleEnabled:function(){$("#include_staff_assessment",this.element).click()},getID:function(){return $(this.element).attr("id")},validate:function(){return!0},validationErrors:function(){return[]},clearValidationErrors:function(){}},OpenAssessment.Fields={stringField:function(sel,value){return void 0!==value&&sel.val(value),sel.val()},booleanField:function(sel,value){return void 0!==value&&sel.prop("checked",value),sel.prop("checked")}},OpenAssessment.IntField=function(inputSel,restrictions){this.max=restrictions.max,this.min=restrictions.min,this.input=$(inputSel)},OpenAssessment.IntField.prototype={get:function(){return parseInt(this.input.val().trim(),10)},set:function(val){this.input.val(val)},validate:function(){var value=this.get(),isValid=!isNaN(value)&&value>=this.min&&value<=this.max;return-1!==this.input.val().indexOf(".")&&(isValid=!1),isValid||this.input.addClass("openassessment_highlighted_field"),isValid},clearValidationErrors:function(){this.input.removeClass("openassessment_highlighted_field")},validationErrors:function(){return this.input.hasClass("openassessment_highlighted_field")?["Int field is invalid"]:[]}},OpenAssessment.ToggleControl=function(checkboxSel,shownSel,hiddenSel,notifier){this.checkbox=checkboxSel,this.shownSection=shownSel,this.hiddenSection=hiddenSel,this.notifier=notifier},OpenAssessment.ToggleControl.prototype={install:function(){return this.checkbox.change(this,function(event){var control=event.data;this.checked?(control.notifier.notificationFired("toggleOn",{}),control.show()):(control.notifier.notificationFired("toggleOff",{}),control.hide())}),this},show:function(){this.hiddenSection.addClass("is--hidden"),this.shownSection.removeClass("is--hidden")},hide:function(){this.shownSection.addClass("is--hidden"),this.hiddenSection.removeClass("is--hidden")}},OpenAssessment.DatetimeControl=function(element,datePicker,timePicker){this.element=element,this.datePicker=datePicker,this.timePicker=timePicker},OpenAssessment.DatetimeControl.prototype={install:function(){var dateString=$(this.datePicker,this.element).val();return $(this.datePicker,this.element).datepicker({showButtonPanel:!0}).datepicker("option","dateFormat","yy-mm-dd").datepicker("setDate",dateString),$(this.timePicker,this.element).timepicker({timeFormat:"H:i",step:60}),this},datetime:function(dateString,timeString){var datePickerSel=$(this.datePicker,this.element),timePickerSel=$(this.timePicker,this.element);return void 0!==dateString&&datePickerSel.val(dateString),void 0!==timeString&&timePickerSel.val(timeString),datePickerSel.val()+"T"+timePickerSel.val()},validate:function(){var dateString=$(this.datePicker,this.element).val(),timeString=$(this.timePicker,this.element).val(),isDateValid=!1;try{isDateValid=$.datepicker.parseDate($.datepicker.ISO_8601,dateString)instanceof Date}catch(err){}isDateValid||$(this.datePicker,this.element).addClass("openassessment_highlighted_field");var isTimeValid=null!==timeString.match(/^\d{2}:\d{2}$/g);return isTimeValid||$(this.timePicker,this.element).addClass("openassessment_highlighted_field"),isDateValid&&isTimeValid},clearValidationErrors:function(){$(this.datePicker,this.element).removeClass("openassessment_highlighted_field"),$(this.timePicker,this.element).removeClass("openassessment_highlighted_field")},validationErrors:function(){var errors=[],dateHasError=$(this.datePicker,this.element).hasClass("openassessment_highlighted_field"),timeHasError=$(this.timePicker,this.element).hasClass("openassessment_highlighted_field");return dateHasError&&errors.push("Date is invalid"),timeHasError&&errors.push("Time is invalid"),errors}},OpenAssessment.SelectControl=function(selectSel,mapping,notifier){this.select=selectSel,this.mapping=mapping,this.notifier=notifier},OpenAssessment.SelectControl.prototype={install:function(){return this.select.change(this,function(event){var control=event.data;control.notifier.notificationFired("selectionChanged",{selected:this.value}),control.change(this.value)}),this},change:function(selected){$.isFunction(this.mapping)?this.mapping(selected):$.each(this.mapping,function(option,sel){option===selected?sel.removeClass("is--hidden"):sel.addClass("is--hidden")})}},OpenAssessment.InputControl=function(inputSel,validator){this.input=$(inputSel),this.validator=validator,this.errors=[]},OpenAssessment.InputControl.prototype={get:function(){return this.input.val()},set:function(val){this.input.val(val)},validate:function(){return this.errors=this.validator(this.get()),this.errors.length&&(this.input.addClass("openassessment_highlighted_field"),this.input.parent().nextAll(".message-status").text(this.errors.join(";")),this.input.parent().nextAll(".message-status").addClass("is-shown")),0===this.errors.length},clearValidationErrors:function(){this.input.removeClass("openassessment_highlighted_field"),this.input.parent().nextAll(".message-status").removeClass("is-shown")},validationErrors:function(){return this.errors}},OpenAssessment.StudentTrainingListener=function(){this.element=$("#oa_student_training_editor"),this.alert=new OpenAssessment.ValidationAlert},OpenAssessment.StudentTrainingListener.prototype={promptAdd:function(){var view=this.element;$("#openassessment_training_example_part_template").children().first().clone().removeAttr("id").toggleClass("is--hidden",!1).appendTo(".openassessment_training_example_essay",view)},promptRemove:function(data){var view=this.element;$(".openassessment_training_example_essay li:nth-child("+(data.index+1)+")",view).remove()},optionUpdated:function(data){this._optionSel(data.criterionName).each(function(){var criterion=this,option=$('option[value="'+data.name+'"]',criterion).attr("data-points",data.points).attr("data-label",data.label);OpenAssessment.ItemUtilities.refreshOptionString(option)})},optionAdd:function(data){var criterionAdded=!1;0===this._optionSel(data.criterionName).length&&(this.criterionAdd(data),criterionAdded=!0),this._optionSel(data.criterionName).each(function(){var criterion=this,option=$("<option></option>").attr("value",data.name).attr("data-points",data.points).attr("data-label",data.label);OpenAssessment.ItemUtilities.refreshOptionString(option),$(criterion).append(option)}),criterionAdded&&this.displayAlertMsg(gettext("Criterion Added"),gettext("You have added a criterion. You will need to select an option for the criterion in the Learner Training step. To do this, click the Settings tab."))},optionRemove:function(data){var handler=this,invalidated=!1;this._optionSel(data.criterionName).each(function(){var criterionOption=this;$(criterionOption).val()===data.name.toString()&&($(criterionOption).val("").addClass("openassessment_highlighted_field").click(function(){$(criterionOption).removeClass("openassessment_highlighted_field")}),invalidated=!0),$('option[value="'+data.name+'"]',criterionOption).remove(),1===$("option",criterionOption).length&&(handler.removeAllOptions(data),invalidated=!1)}),invalidated&&this.displayAlertMsg(gettext("Option Deleted"),gettext("You have deleted an option. That option has been removed from its criterion in the sample responses in the Learner Training step. You might have to select a new option for the criterion."))},_optionSel:function(criterionName){return $('.openassessment_training_example_criterion_option[data-criterion="'+criterionName+'"]',this.element)},removeAllOptions:function(data){var changed=!1;$(".openassessment_training_example_criterion",this.element).each(function(){var criterion=this;$(criterion).data("criterion")===data.criterionName&&($(criterion).remove(),changed=!0)}),changed&&this.displayAlertMsg(gettext("Option Deleted"),gettext("You have deleted all the options for this criterion. The criterion has been removed from the sample responses in the Learner Training step."))},criterionRemove:function(data){var changed=!1,sel='.openassessment_training_example_criterion[data-criterion="'+data.criterionName+'"]';$(sel,this.element).each(function(){$(this).remove(),changed=!0}),changed&&this.displayAlertMsg(gettext("Criterion Deleted"),gettext("You have deleted a criterion. The criterion has been removed from the example responses in the Learner Training step."))},displayAlertMsg:function(title,msg){$("#include_student_training",this.element).is(":checked")&&$(".openassessment_training_example",this.element).length>1&&this.alert.setMessage(title,msg).show()},criterionUpdated:function(data){var sel='.openassessment_training_example_criterion[data-criterion="'+data.criterionName+'"]';$(sel,this.element).each(function(){$(".openassessment_training_example_criterion_name_wrapper",this).text(data.criterionLabel)})},criterionAdd:function(data){var view=this.element,criterion=$("#openassessment_training_example_criterion_template").children().first().clone().removeAttr("id").attr("data-criterion",data.criterionName).toggleClass("is--hidden",!1).appendTo(".openassessment_training_example_criteria_selections",view);criterion.find(".openassessment_training_example_criterion_option").attr("data-criterion",data.criterionName),criterion.find(".openassessment_training_example_criterion_name_wrapper").text(data.label)},examplesCriteriaLabels:function(){var examples=[];return $(".openassessment_training_example_criteria_selections",this.element).each(function(){var exampleDescription={};$(".openassessment_training_example_criterion",this).each(function(){var criterionName=$(this).data("criterion"),criterionLabel=$(".openassessment_training_example_criterion_name_wrapper",this).text().trim();exampleDescription[criterionName]=criterionLabel}),examples.push(exampleDescription)}),examples},examplesOptionsLabels:function(){var examples=[];return $(".openassessment_training_example_criteria_selections",this.element).each(function(){var exampleDescription={};$(".openassessment_training_example_criterion_option",this).each(function(){var criterionName=$(this).data("criterion");exampleDescription[criterionName]={},$("option",this).each(function(){var optionName=$(this).val(),optionLabel=$(this).text().trim();exampleDescription[criterionName][optionName]=optionLabel})}),examples.push(exampleDescription)}),examples}},OpenAssessment.AssessmentToggleListener=function(){this.alert=new OpenAssessment.ValidationAlert},OpenAssessment.AssessmentToggleListener.prototype={toggleOff:function(){this.alert.setMessage(gettext("Warning"),gettext("Changes to steps that are not selected as part of the assignment will not be saved.")).show()},toggleOn:function(){this.alert.hide()}},OpenAssessment.Notifier=function(listeners){this.listeners=listeners},OpenAssessment.Notifier.prototype={notificationFired:function(name,data){for(var i=0;i<this.listeners.length;i++)"function"==typeof this.listeners[i][name]&&this.listeners[i][name](data)}},OpenAssessment.EditPromptsView=function(element,notifier){this.element=element,this.editorElement=$(this.element).closest("#openassessment-editor"),this.addRemoveEnabled="true"!==this.editorElement.attr("data-is-released"),this.promptsContainer=new OpenAssessment.Container(OpenAssessment.Prompt,{containerElement:$("#openassessment_prompts_list",this.element).get(0),templateElement:$("#openassessment_prompt_template",this.element).get(0),addButtonElement:$("#openassessment_prompts_add_prompt",this.element).get(0),removeButtonClass:"openassessment_prompt_remove_button",containerItemClass:"openassessment_prompt",notifier:notifier,addRemoveEnabled:this.addRemoveEnabled}),this.promptsContainer.addEventListeners()},OpenAssessment.EditPromptsView.prototype={promptsDefinition:function(){return this.promptsContainer.getItemValues()},addPrompt:function(){this.addRemoveEnabled&&this.promptsContainer.add()},removePrompt:function(item){this.addRemoveEnabled&&this.promptsContainer.remove(item)},getAllPrompts:function(){return this.promptsContainer.getAllItems()},getPromptItem:function(index){return this.promptsContainer.getItem(index)},validate:function(){return!0},validationErrors:function(){return[]},clearValidationErrors:function(){}},OpenAssessment.EditRubricView=function(element,notifier){this.element=element,this.criterionAddButton=$("#openassessment_rubric_add_criterion",this.element),this.criteriaContainer=new OpenAssessment.Container(OpenAssessment.RubricCriterion,{containerElement:$("#openassessment_criterion_list",this.element).get(0),templateElement:$("#openassessment_criterion_template",this.element).get(0),addButtonElement:$("#openassessment_rubric_add_criterion",this.element).get(0),removeButtonClass:"openassessment_criterion_remove_button",containerItemClass:"openassessment_criterion",notifier:notifier}),this.criteriaContainer.addEventListeners()},OpenAssessment.EditRubricView.prototype={criteriaDefinition:function(){for(var criteria=this.criteriaContainer.getItemValues(),criterionIndex=0;criterionIndex<criteria.length;criterionIndex++){var criterion=criteria[criterionIndex];criterion.order_num=criterionIndex;for(var optionIndex=0;optionIndex<criterion.options.length;optionIndex++)criterion.options[optionIndex].order_num=optionIndex}return criteria},feedbackPrompt:function(text){var sel=$("#openassessment_rubric_feedback",this.element);return OpenAssessment.Fields.stringField(sel,text)},feedback_default_text:function(text){var sel=$("#openassessment_rubric_feedback_default_text",this.element);return OpenAssessment.Fields.stringField(sel,text)},addCriterion:function(){this.criteriaContainer.add()},removeCriterion:function(item){this.criteriaContainer.remove(item)},getAllCriteria:function(){return this.criteriaContainer.getAllItems()},getCriterionItem:function(index){return this.criteriaContainer.getItem(index)},addOption:function(criterionIndex){this.getCriterionItem(criterionIndex).optionContainer.add()},removeOption:function(criterionIndex,item){this.getCriterionItem(criterionIndex).optionContainer.remove(item)},getAllOptions:function(criterionIndex){return this.getCriterionItem(criterionIndex).optionContainer.getAllItems()},getOptionItem:function(criterionIndex,optionIndex){return this.getCriterionItem(criterionIndex).optionContainer.getItem(optionIndex)},validate:function(){var criteria=this.getAllCriteria(),isValid=criteria.length>0;return isValid||this.criterionAddButton.addClass("openassessment_highlighted_field").click(function(){$(this).removeClass("openassessment_highlighted_field")}),$.each(criteria,function(){isValid=this.validate()&&isValid}),isValid},validationErrors:function(){var errors=[];return this.criterionAddButton.hasClass("openassessment_highlighted_field")&&errors.push("The rubric must contain at least one criterion"),$.each(this.getAllCriteria(),function(){errors=errors.concat(this.validationErrors())}),errors},clearValidationErrors:function(){this.criterionAddButton.removeClass("openassessment_highlighted_field"),$.each(this.getAllCriteria(),function(){this.clearValidationErrors()})}},OpenAssessment.EditSettingsView=function(element,assessmentViews,data){var self=this;this.settingsElement=element,this.assessmentsElement=$(element).siblings("#openassessment_assessment_module_settings_editors").get(0),this.assessmentViews=assessmentViews,this.startDatetimeControl=new OpenAssessment.DatetimeControl(this.element,"#openassessment_submission_start_date","#openassessment_submission_start_time").install(),this.dueDatetimeControl=new OpenAssessment.DatetimeControl(this.element,"#openassessment_submission_due_date","#openassessment_submission_due_time").install(),new OpenAssessment.SelectControl($("#openassessment_submission_file_upload_response",this.element),function(selectedValue){var el=$("#openassessment_submission_file_upload_type_wrapper",self.element);selectedValue?el.removeClass("is--hidden"):el.addClass("is--hidden")},new OpenAssessment.Notifier([new OpenAssessment.AssessmentToggleListener])).install(),new OpenAssessment.SelectControl($("#openassessment_submission_upload_selector",this.element),{custom:$("#openassessment_submission_white_listed_file_types_wrapper",this.element)},new OpenAssessment.Notifier([new OpenAssessment.AssessmentToggleListener])).install(),this.leaderboardIntField=new OpenAssessment.IntField($("#openassessment_leaderboard_editor",this.element),{min:0,max:100}),this.fileTypeWhiteListInputField=new OpenAssessment.InputControl($("#openassessment_submission_white_listed_file_types",this.element),function(value){var badExts=[],errors=[];if(!value)return errors.push(gettext("File types can not be empty.")),errors;var whiteList=$.map(value.replace(/\./g,"").toLowerCase().split(","),$.trim);return $.each(whiteList,function(index,ext){-1!==data.FILE_EXT_BLACK_LIST.indexOf(ext)&&badExts.push(ext)}),badExts.length&&errors.push(gettext("The following file types are not allowed: ")+badExts.join(",")),errors}),this.initializeSortableAssessments()},OpenAssessment.EditSettingsView.prototype={initializeSortableAssessments:function(){var view=this;$("#openassessment_assessment_module_settings_editors",view.element).sortable({start:function(event,ui){$(".openassessment_assessment_module_editor",view.element).hide();ui.placeholder.height("auto"),ui.helper.height("auto"),$("#openassessment_assessment_module_settings_editors",view.element).sortable("refresh").sortable("refreshPositions")},stop:function(){$(".openassessment_assessment_module_editor",view.element).show()},snap:!0,axis:"y",handle:".drag-handle",cursorAt:{top:20}}),$("#openassessment_assessment_module_settings_editors .drag-handle",view.element).disableSelection()},displayName:function(name){var sel=$("#openassessment_title_editor",this.settingsElement);return OpenAssessment.Fields.stringField(sel,name)},submissionStart:function(dateString,timeString){return this.startDatetimeControl.datetime(dateString,timeString)},submissionDue:function(dateString,timeString){return this.dueDatetimeControl.datetime(dateString,timeString)},textResponseNecessity:function(value){var sel=$("#openassessment_submission_text_response",this.settingsElement);return void 0!==value&&sel.val(value),sel.val()},fileUploadResponseNecessity:function(value,triggerChange){var sel=$("#openassessment_submission_file_upload_response",this.settingsElement);return void 0!==value&&(triggerChange=triggerChange||!1,sel.val(value),triggerChange&&$(sel).trigger("change")),sel.val()},fileUploadType:function(uploadType){var fileUploadTypeWrapper=$("#openassessment_submission_file_upload_type_wrapper",this.settingsElement);if(!$(fileUploadTypeWrapper).hasClass("is--hidden")){var sel=$("#openassessment_submission_upload_selector",this.settingsElement);return void 0!==uploadType&&sel.val(uploadType),sel.val()}return""},fileTypeWhiteList:function(exts){return void 0!==exts&&this.fileTypeWhiteListInputField.set(exts),this.fileTypeWhiteListInputField.get()},latexEnabled:function(isEnabled){var sel=$("#openassessment_submission_latex_editor",this.settingsElement);return void 0!==isEnabled&&(isEnabled?sel.val(1):sel.val(0)),"1"===sel.val()},leaderboardNum:function(num){return void 0!==num&&this.leaderboardIntField.set(num),this.leaderboardIntField.get(num)},assessmentsDescription:function(){var assessmentDescList=[],view=this;return $(".openassessment_assessment_module_settings_editor",this.assessmentsElement).each(function(){var asmntView=view.assessmentViews[$(this).attr("id")];if(asmntView.isEnabled()){var description=asmntView.description();description.name=asmntView.name,assessmentDescList.push(description)}}),assessmentDescList},editorAssessmentsOrder:function(){var editorAssessments=[],view=this;return $(".openassessment_assessment_module_settings_editor",this.assessmentsElement).each(function(){var asmntView=view.assessmentViews[$(this).attr("id")];editorAssessments.push(asmntView.name)}),editorAssessments},validate:function(){var isValid=!0;return isValid=this.startDatetimeControl.validate()&&isValid,isValid=this.dueDatetimeControl.validate()&&isValid,isValid=this.leaderboardIntField.validate()&&isValid,"custom"===this.fileUploadType()?isValid=this.fileTypeWhiteListInputField.validate()&&isValid:this.fileTypeWhiteListInputField.get()&&!this.fileTypeWhiteListInputField.validate()&&this.fileTypeWhiteListInputField.set(""),$.each(this.assessmentViews,function(){this.isEnabled()&&(isValid=this.validate()&&isValid)}),isValid},validationErrors:function(){var errors=[];return this.startDatetimeControl.validationErrors().length>0&&errors.push("Submission start is invalid"),this.dueDatetimeControl.validationErrors().length>0&&errors.push("Submission due is invalid"),this.leaderboardIntField.validationErrors().length>0&&errors.push("Leaderboard number is invalid"),this.fileTypeWhiteListInputField.validationErrors().length>0&&(errors=errors.concat(this.fileTypeWhiteListInputField.validationErrors())),$.each(this.assessmentViews,function(){errors=errors.concat(this.validationErrors())}),errors},clearValidationErrors:function(){this.startDatetimeControl.clearValidationErrors(),this.dueDatetimeControl.clearValidationErrors(),this.leaderboardIntField.clearValidationErrors(),this.fileTypeWhiteListInputField.clearValidationErrors(),$.each(this.assessmentViews,function(){this.clearValidationErrors()})}},OpenAssessment.ValidationAlert=function(){this.element=$("#openassessment_validation_alert"),this.editorElement=$(this.element).parent(),this.title=$(".openassessment_alert_title",this.element),this.message=$(".openassessment_alert_message",this.element),this.closeButton=$(".openassessment_alert_close",this.element),this.ALERT_YELLOW="rgb(192, 172, 0)",this.DARK_GREY="#323232"},OpenAssessment.ValidationAlert.prototype={install:function(){var alert=this;return this.closeButton.click(function(eventObject){eventObject.preventDefault(),alert.hide()}),this},hide:function(){var headerHeight=$("#openassessment_editor_header",this.editorElement).outerHeight();this.element.addClass("covered");var styles={height:"Calc(100% - "+headerHeight+"px)","border-top-right-radius":"3px","border-top-left-radius":"3px"};return $(".oa_editor_content_wrapper",this.editorElement).each(function(){$(this).css(styles)}),this},show:function(){var view=this;if(this.isVisible())$(this.element).animate({"background-color":view.ALERT_YELLOW},300,"swing",function(){$(this).animate({"background-color":view.DARK_GREY},700,"swing")});else{this.element.removeClass("covered");var alertHeight=this.element.outerHeight(),headerHeight=$("#openassessment_editor_header",this.editorElement).outerHeight(),styles={height:"Calc(100% - "+(alertHeight+headerHeight)+"px)","border-top-right-radius":"0px","border-top-left-radius":"0px"};$(".oa_editor_content_wrapper",this.editorElement).each(function(){$(this).css(styles),$(this).scrollTop($(this).scrollTop()+alertHeight)})}return this},setMessage:function(newTitle,newMessage){return this.title.text(newTitle),this.message.text(newMessage),this},isVisible:function(){return!this.element.hasClass("covered")},getTitle:function(){return this.title.text()},getMessage:function(){return this.message.text()}},function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return a.Backgrid=b(c,d)}):"object"==typeof exports?module.exports=b(require("underscore"),require("backbone")):a.Backgrid=b(a._,a.Backbone)}(this,function(a,b){"use strict";function c(a,b,c){var d=b-(a+"").length;d=d<0?0:d;for(var e="",f=0;f<d;f++)e+=c;return e+a}var d="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff";if(!String.prototype.trim||d.trim()){d="["+d+"]";var e=new RegExp("^"+d+d+"*"),f=new RegExp(d+d+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(e,"").replace(f,"")}}var g=b.$,h={Extension:{},resolveNameToClass:function(b,c){if(a.isString(b)){var d=a.map(b.split("-"),function(a){return a.slice(0,1).toUpperCase()+a.slice(1)}).join("")+c,e=h[d]||h.Extension[d];if(a.isUndefined(e))throw new ReferenceError("Class '"+d+"' not found");return e}return b},callByNeed:function(){var b=arguments[0];if(!a.isFunction(b))return b;var c=arguments[1],d=[].slice.call(arguments,2);return b.apply(c,d+""?d:[])}};a.extend(h,b.Events);var i=h.Command=function(b){a.extend(this,{altKey:!!b.altKey,char:b.char,charCode:b.charCode,ctrlKey:!!b.ctrlKey,key:b.key,keyCode:b.keyCode,locale:b.locale,location:b.location,metaKey:!!b.metaKey,repeat:!!b.repeat,shiftKey:!!b.shiftKey,which:b.which})};a.extend(i.prototype,{moveUp:function(){return 38==this.keyCode},moveDown:function(){return 40===this.keyCode},moveLeft:function(){return this.shiftKey&&9===this.keyCode},moveRight:function(){return!this.shiftKey&&9===this.keyCode},save:function(){return 13===this.keyCode},cancel:function(){return 27===this.keyCode},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var j=h.CellFormatter=function(){};a.extend(j.prototype,{fromRaw:function(a,b){return a},toRaw:function(a,b){return a}});var k=h.NumberFormatter=function(b){if(a.extend(this,this.defaults,b||{}),this.decimals<0||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};k.prototype=new j,a.extend(k.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(b,c){if(a.isNull(b)||a.isUndefined(b))return"";var d=(b=parseFloat(b).toFixed(~~this.decimals)).split("."),e=d[0],f=d[1]?(this.decimalSeparator||".")+d[1]:"";return e.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+f},toRaw:function(b,c){if(""===(b=b.trim()))return null;for(var d="",e=b.split(this.orderSeparator),f=0;f<e.length;f++)d+=e[f];var g=d.split(this.decimalSeparator);d="";for(f=0;f<g.length;f++)d=d+g[f]+".";"."===d[d.length-1]&&(d=d.slice(0,d.length-1));var h=1*(1*d).toFixed(~~this.decimals);return a.isNumber(h)&&!a.isNaN(h)?h:void 0}});var l=h.PercentFormatter=function(){h.NumberFormatter.apply(this,arguments)};l.prototype=new h.NumberFormatter,a.extend(l.prototype,{defaults:a.extend({},k.prototype.defaults,{multiplier:1,symbol:"%"}),fromRaw:function(a,b){var c=[].slice.call(arguments,1);return c.unshift(a*this.multiplier),(k.prototype.fromRaw.apply(this,c)||"0")+this.symbol},toRaw:function(b,c){var d=b.split(this.symbol);if(d&&d[0]&&""===d[1]||null==d[1]){var e=k.prototype.toRaw.call(this,d[0]);return a.isUndefined(e)?e:e/this.multiplier}}});var m=h.DatetimeFormatter=function(b){if(a.extend(this,this.defaults,b||{}),!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};m.prototype=new j,a.extend(m.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(b,d){if(""===(b+"").trim())return null;var e,f=null;if(a.isNumber(b))e=c((g=new Date(b)).getUTCFullYear(),4,0)+"-"+c(g.getUTCMonth()+1,2,0)+"-"+c(g.getUTCDate(),2,0),f=c(g.getUTCHours(),2,0)+":"+c(g.getUTCMinutes(),2,0)+":"+c(g.getUTCSeconds(),2,0);else{var h=(b=b.trim()).split(this.ISO_SPLITTER_RE)||[];f=(e=this.DATE_RE.test(h[0])?h[0]:"")&&h[1]?h[1]:this.TIME_RE.test(h[0])?h[0]:""}var i=this.DATE_RE.exec(e)||[],j=this.TIME_RE.exec(f)||[];if(d){if(this.includeDate&&a.isUndefined(i[0]))return;if(this.includeTime&&a.isUndefined(j[0]))return;if(!this.includeDate&&e)return;if(!this.includeTime&&f)return}var g=new Date(Date.UTC(1*i[1]||0,1*i[2]-1||0,1*i[3]||0,1*j[1]||null,1*j[2]||null,1*j[3]||null,1*j[5]||null)),k="";return this.includeDate&&(k=c(g.getUTCFullYear(),4,0)+"-"+c(g.getUTCMonth()+1,2,0)+"-"+c(g.getUTCDate(),2,0)),this.includeTime&&(k=k+(this.includeDate?"T":"")+c(g.getUTCHours(),2,0)+":"+c(g.getUTCMinutes(),2,0)+":"+c(g.getUTCSeconds(),2,0),this.includeMilli&&(k=k+"."+c(g.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(k+="Z"),k},fromRaw:function(b,c){return a.isNull(b)||a.isUndefined(b)?"":this._convert(b)},toRaw:function(a,b){return this._convert(a,!0)}});var n=h.StringFormatter=function(){};n.prototype=new j,a.extend(n.prototype,{fromRaw:function(b,c){return a.isUndefined(b)||a.isNull(b)?"":b+""}});var o=h.EmailFormatter=function(){};o.prototype=new j,a.extend(o.prototype,{toRaw:function(b,c){var d=b.trim().split("@");if(2===d.length&&a.all(d))return b}});var p=h.SelectFormatter=function(){};p.prototype=new j,a.extend(p.prototype,{fromRaw:function(b,c){return a.isArray(b)?b:null!=b?[b]:[]}});var q=h.CellEditor=b.View.extend({initialize:function(a){this.formatter=a.formatter,this.column=a.column,this.column instanceof B||(this.column=new B(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(a,b){return null!=b&&b.get("name")!=this.column.get("name")||this.$el.focus(),this}}),r=h.InputCellEditor=q.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(a){r.__super__.initialize.apply(this,arguments),a.placeholder&&this.$el.attr("placeholder",a.placeholder)},render:function(){var a=this.model;return this.$el.val(this.formatter.fromRaw(a.get(this.column.get("name")),a)),this},saveOrCancel:function(b){var c=this.formatter,d=this.model,e=this.column,f=new i(b),g="blur"===b.type;if(f.moveUp()||f.moveDown()||f.moveLeft()||f.moveRight()||f.save()||g){b.preventDefault(),b.stopPropagation();var h=this.$el.val(),j=c.toRaw(h,d);a.isUndefined(j)?d.trigger("backgrid:error",d,e,h):(d.set(e.get("name"),j),d.trigger("backgrid:edited",d,e,f))}else f.cancel()&&(b.stopPropagation(),d.trigger("backgrid:edited",d,e,f))},postRender:function(a,b){if(null==b||b.get("name")==this.column.get("name"))if("right"===this.$el.css("text-align")){var c=this.$el.val();this.$el.focus().val(null).val(c)}else this.$el.focus();return this}}),s=h.Cell=b.View.extend({tagName:"td",formatter:j,editor:r,events:{click:"enterEditMode"},initialize:function(b){this.column=b.column,this.column instanceof B||(this.column=new B(this.column));var c=this.column,d=this.model,e=this.$el,f=h.resolveNameToClass(c.get("formatter")||this.formatter,"Formatter");a.isFunction(f.fromRaw)||a.isFunction(f.toRaw)||(f=new f),this.formatter=f,this.editor=h.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(d,"change:"+c.get("name"),function(){e.hasClass("editor")||this.render()}),this.listenTo(d,"backgrid:error",this.renderError),this.listenTo(c,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var c in b)b.hasOwnProperty(c)&&e.toggleClass(c,b[c])}),this.updateStateClassesMaybe()},updateStateClassesMaybe:function(){var a=this.model,b=this.column,c=this.$el;c.toggleClass("editable",h.callByNeed(b.editable(),b,a)),c.toggleClass("sortable",h.callByNeed(b.sortable(),b,a)),c.toggleClass("renderable",h.callByNeed(b.renderable(),b,a))},render:function(){var a=this.$el;a.empty();var b=this.model,c=this.column.get("name");return a.text(this.formatter.fromRaw(b.get(c),b)),a.addClass(c),this.updateStateClassesMaybe(),this.delegateEvents(),this},enterEditMode:function(){var a=this.model,b=this.column;h.callByNeed(b.editable(),b,a)&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),a.trigger("backgrid:edit",a,b,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),a.trigger("backgrid:editing",a,b,this,this.currentEditor))},renderError:function(a,b){null!=b&&b.get("name")!=this.column.get("name")||this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),s.__super__.remove.apply(this,arguments)}}),t=h.StringCell=s.extend({className:"string-cell",formatter:n}),u=h.UriCell=s.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(a){u.__super__.initialize.apply(this,arguments),this.title=a.title||this.title,this.target=a.target||this.target},render:function(){this.$el.empty();var a=this.model.get(this.column.get("name")),b=this.formatter.fromRaw(a,this.model);return this.$el.append(g("<a>",{tabIndex:-1,href:a,title:this.title||b,target:this.target}).text(b)),this.delegateEvents(),this}}),v=(h.EmailCell=t.extend({className:"email-cell",formatter:o,render:function(){this.$el.empty();var a=this.model,b=this.formatter.fromRaw(a.get(this.column.get("name")),a);return this.$el.append(g("<a>",{tabIndex:-1,href:"mailto:"+b,title:b}).text(b)),this.delegateEvents(),this}}),h.NumberCell=s.extend({className:"number-cell",decimals:k.prototype.defaults.decimals,decimalSeparator:k.prototype.defaults.decimalSeparator,orderSeparator:k.prototype.defaults.orderSeparator,formatter:k,initialize:function(a){v.__super__.initialize.apply(this,arguments);var b=this.formatter;b.decimals=this.decimals,b.decimalSeparator=this.decimalSeparator,b.orderSeparator=this.orderSeparator}})),w=(h.IntegerCell=v.extend({className:"integer-cell",decimals:0}),h.PercentCell=v.extend({className:"percent-cell",multiplier:l.prototype.defaults.multiplier,symbol:l.prototype.defaults.symbol,formatter:l,initialize:function(){w.__super__.initialize.apply(this,arguments);var a=this.formatter;a.multiplier=this.multiplier,a.symbol=this.symbol}})),x=h.DatetimeCell=s.extend({className:"datetime-cell",includeDate:m.prototype.defaults.includeDate,includeTime:m.prototype.defaults.includeTime,includeMilli:m.prototype.defaults.includeMilli,formatter:m,initialize:function(b){x.__super__.initialize.apply(this,arguments);var c=this.formatter;c.includeDate=this.includeDate,c.includeTime=this.includeTime,c.includeMilli=this.includeMilli;var d=this.includeDate?"YYYY-MM-DD":"";d+=this.includeDate&&this.includeTime?"T":"",d+=this.includeTime?"HH:mm:ss":"",d+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:a.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:d})})}}),y=(h.DateCell=x.extend({className:"date-cell",includeTime:!1}),h.TimeCell=x.extend({className:"time-cell",includeDate:!1}),h.BooleanCellEditor=q.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var a=this.model,b=this.formatter.fromRaw(a.get(this.column.get("name")),a);return this.$el.prop("checked",b),this},enterOrExitEditMode:function(a){if(!this.mouseDown){var b=this.model;b.trigger("backgrid:edited",b,this.column,new i(a))}},saveOrCancel:function(a){var b=this.model,c=this.column,d=this.formatter,e=new i(a);if(e.passThru()&&"change"!=a.type)return!0;e.cancel()&&(a.stopPropagation(),b.trigger("backgrid:edited",b,c,e));var f=this.$el;if(e.save()||e.moveLeft()||e.moveRight()||e.moveUp()||e.moveDown()){a.preventDefault(),a.stopPropagation();g=d.toRaw(f.prop("checked"),b);b.set(c.get("name"),g),b.trigger("backgrid:edited",b,c,e)}else if("change"==a.type){var g=d.toRaw(f.prop("checked"),b);b.set(c.get("name"),g),f.focus()}}})),z=(h.BooleanCell=s.extend({className:"boolean-cell",editor:y,events:{click:"enterEditMode"},render:function(){this.$el.empty();var a=this.model,b=this.column,c=h.callByNeed(b.editable(),b,a);return this.$el.append(g("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(a.get(b.get("name")),a),disabled:!c})),this.delegateEvents(),this}}),h.SelectCellEditor=q.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:a.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>',null,{variable:null,evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g}),setOptionValues:function(b){this.optionValues=b,this.optionValues=a.result(this,"optionValues")},setMultiple:function(a){this.multiple=a,this.$el.prop("multiple",a)},_renderOptions:function(b,c){for(var d="",e=0;e<b.length;e++)d+=this.template({text:b[e][0],value:b[e][1],selected:a.indexOf(c,b[e][1])>-1});return d},render:function(){this.$el.empty();var b=a.result(this,"optionValues"),c=this.model,d=this.formatter.fromRaw(c.get(this.column.get("name")),c);if(!a.isArray(b))throw new TypeError("optionValues must be an array");for(var e=null,f=null,e=null,h=null,i=null,j=0;j<b.length;j++){e=b[j];if(a.isArray(e))f=e[0],e=e[1],this.$el.append(this.template({text:f,value:e,selected:a.indexOf(d,e)>-1}));else{if(!a.isObject(e))throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");h=e.name,(i=g("<optgroup></optgroup>",{label:h})).append(this._renderOptions.call(this,e.values,d)),this.$el.append(i)}}return this.delegateEvents(),this},save:function(a){var b=this.model,c=this.column;b.set(c.get("name"),this.formatter.toRaw(this.$el.val(),b))},close:function(a){var b=this.model,c=this.column,d=new i(a);d.cancel()?(a.stopPropagation(),b.trigger("backgrid:edited",b,c,new i(a))):(d.save()||d.moveLeft()||d.moveRight()||d.moveUp()||d.moveDown()||"blur"==a.type)&&(a.preventDefault(),a.stopPropagation(),this.save(a),b.trigger("backgrid:edited",b,c,new i(a)))}})),A=h.SelectCell=s.extend({className:"select-cell",editor:z,multiple:!1,formatter:p,optionValues:void 0,delimiter:", ",initialize:function(a){A.__super__.initialize.apply(this,arguments),this.listenTo(this.model,"backgrid:edit",function(a,b,c,d){b.get("name")==this.column.get("name")&&(d.setOptionValues(this.optionValues),d.setMultiple(this.multiple))})},render:function(){this.$el.empty();var b=a.result(this,"optionValues"),c=this.model,d=this.formatter.fromRaw(c.get(this.column.get("name")),c),e=[];try{if(!a.isArray(b)||a.isEmpty(b))throw new TypeError;for(var f=0;f<d.length;f++)for(var g=d[f],h=0;h<b.length;h++){var i=b[h];if(a.isArray(i)){var j=i[0];(i=i[1])==g&&e.push(j)}else{if(!a.isObject(i))throw new TypeError;for(var k=i.values,l=0;l<k.length;l++){var m=k[l];m[1]==g&&e.push(m[0])}}}this.$el.append(e.join(this.delimiter))}catch(a){if(a instanceof TypeError)throw new TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw a}return this.delegateEvents(),this}}),B=h.Column=b.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,sortType:"cycle",sortValue:void 0,direction:null,cell:void 0,headerCell:void 0},initialize:function(){this.has("label")||this.set({label:this.get("name")},{silent:!0});var a=h.resolveNameToClass(this.get("headerCell"),"HeaderCell"),b=h.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:b,headerCell:a},{silent:!0})},sortValue:function(){var b=this.get("sortValue");return a.isString(b)?this[b]:a.isFunction(b)?b:function(a,b){return a.get(b)}}});a.each(["sortable","renderable","editable"],function(b){B.prototype[b]=function(){var c=this.get(b);return a.isString(c)?this[c]:a.isFunction(c)?c:!!c}});var C=h.Columns=b.Collection.extend({model:B}),D=h.Row=b.View.extend({tagName:"tr",initialize:function(a){var c=this.columns=a.columns;c instanceof b.Collection||(c=this.columns=new C(c));for(var d=this.cells=[],e=0;e<c.length;e++)d.push(this.makeCell(c.at(e),a));this.listenTo(c,"add",function(b,c){var e=c.indexOf(b),f=this.makeCell(b,a);d.splice(e,0,f);var g=this.$el;0===e?g.prepend(f.render().$el):e===c.length-1?g.append(f.render().$el):g.children().eq(e).before(f.render().$el)}),this.listenTo(c,"remove",function(a,b,c){d[c.index].remove(),d.splice(c.index,1)})},makeCell:function(a){return new(a.get("cell"))({column:a,model:this.model})},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.cells.length;b++)a.appendChild(this.cells[b].render().el);return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.cells.length;a++){var c=this.cells[a];c.remove.apply(c,arguments)}return b.View.prototype.remove.apply(this,arguments)}}),E=h.EmptyRow=b.View.extend({tagName:"tr",emptyText:null,initialize:function(a){this.emptyText=a.emptyText,this.columns=a.columns},render:function(){this.$el.empty();var b=document.createElement("td");b.setAttribute("colspan",this.columns.length);var c=document.createElement("span");return c.innerHTML=a.result(this,"emptyText"),b.appendChild(c),this.el.className="empty",this.el.appendChild(b),this}}),F=h.HeaderCell=b.View.extend({tagName:"th",events:{"click button":"onClick"},initialize:function(a){this.column=a.column,this.column instanceof B||(this.column=new B(this.column));var b=this.column,c=this.collection,d=this.$el;this.listenTo(b,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var c in b)b.hasOwnProperty(c)&&d.toggleClass(c,b[c])}),this.listenTo(b,"change:direction",this.setCellDirection),this.listenTo(b,"change:name change:label",this.render),h.callByNeed(b.editable(),b,c)&&d.addClass("editable"),h.callByNeed(b.sortable(),b,c)&&d.addClass("sortable"),h.callByNeed(b.renderable(),b,c)&&d.addClass("renderable"),this.listenTo(c.fullCollection||c,"backgrid:sorted",this.removeCellDirection)},removeCellDirection:function(){this.$el.removeClass("ascending").removeClass("descending"),this.column.set("direction",null)},setCellDirection:function(a,b){this.$el.removeClass("ascending").removeClass("descending"),a.cid==this.column.cid&&this.$el.addClass(b)},onClick:function(a){a.preventDefault();var d=this.column,e=this.collection,f="backgrid:sort";h.callByNeed(d.sortable(),d,this.collection)&&("toggle"===d.get("sortType")?function(a,b){"ascending"===d.get("direction")?e.trigger(f,b,"descending"):e.trigger(f,b,"ascending")}(0,d):function(a,b){"ascending"===d.get("direction")?e.trigger(f,b,"descending"):"descending"===d.get("direction")?e.trigger(f,b,null):e.trigger(f,b,"ascending")}(0,d))},render:function(){this.$el.empty();var a,b=this.column;return a=h.callByNeed(b.sortable(),b,this.collection)?g("<button>").text(b.get("label")).append("<span class='sort-caret' aria-hidden='true'></span>"):document.createTextNode(b.get("label")),this.$el.append(a),this.$el.addClass(b.get("name")),this.$el.addClass(b.get("direction")),this.delegateEvents(),this}}),G=(h.HeaderRow=h.Row.extend({initialize:function(){h.Row.prototype.initialize.apply(this,arguments)},makeCell:function(a,b){var c=a.get("headerCell")||b.headerCell||F;return c=new c({column:a,collection:this.collection})}}),h.Header=b.View.extend({tagName:"thead",initialize:function(a){this.columns=a.columns,this.columns instanceof b.Collection||(this.columns=new C(this.columns)),this.row=new h.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),b.View.prototype.remove.apply(this,arguments)}})),H=h.Body=b.View.extend({tagName:"tbody",initialize:function(a){this.columns=a.columns,this.columns instanceof b.Collection||(this.columns=new C(this.columns)),this.row=a.row||this.row||D,this.rows=this.collection.map(function(a){return new this.row({columns:this.columns,model:a})},this),this.emptyText=a.emptyText,this._unshiftEmptyRowMayBe();var c=this.collection;this.listenTo(c,"add",this.insertRow),this.listenTo(c,"remove",this.removeRow),this.listenTo(c,"sort",this.refresh),this.listenTo(c,"reset",this.refresh),this.listenTo(c,"backgrid:sort",this.sort),this.listenTo(c,"backgrid:edited",this.moveToNextCell),this.listenTo(this.columns,"add remove",this.updateEmptyRow)},_unshiftEmptyRowMayBe:function(){if(0===this.rows.length&&null!=this.emptyText)return this.emptyRow=new E({emptyText:this.emptyText,columns:this.columns}),this.rows.unshift(this.emptyRow),!0},insertRow:function(a,c,d){if(this.rows[0]instanceof E&&this.rows.pop().remove(),c instanceof b.Collection||d){var e=new this.row({columns:this.columns,model:a}),f=c.indexOf(a);this.rows.splice(f,0,e);var g=this.$el,h=g.children(),i=e.render().$el;return f>=h.length?g.append(i):h.eq(f).before(i),this}this.collection.add(a,d=c)},removeRow:function(b,c,d){return d?((a.isUndefined(d.render)||d.render)&&this.rows[d.index].remove(),this.rows.splice(d.index,1),this._unshiftEmptyRowMayBe()&&this.render(),this):(this.collection.remove(b,d=c),void(this._unshiftEmptyRowMayBe()&&this.render()))},updateEmptyRow:function(){null!=this.emptyRow&&this.emptyRow.render()},refresh:function(){for(var a=0;a<this.rows.length;a++)this.rows[a].remove();return this.rows=this.collection.map(function(a){return new this.row({columns:this.columns,model:a})},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.rows.length;b++){var c=this.rows[b];a.appendChild(c.render().el)}return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.rows.length;a++){var c=this.rows[a];c.remove.apply(c,arguments)}return b.View.prototype.remove.apply(this,arguments)},sort:function(c,d){if(!a.contains(["ascending","descending",null],d))throw new RangeError('direction must be one of "ascending", "descending" or `null`');a.isString(c)&&(c=this.columns.findWhere({name:c}));var e,f=this.collection;e="ascending"===d?-1:"descending"===d?1:null;var g=this.makeComparator(c.get("name"),e,e?c.sortValue():function(a){return 1*a.cid.replace("c","")});return b.PageableCollection&&f instanceof b.PageableCollection?(f.setSorting(e&&c.get("name"),e,{sortValue:c.sortValue()}),f.fullCollection?(null==f.fullCollection.comparator&&(f.fullCollection.comparator=g),f.fullCollection.sort(),f.trigger("backgrid:sorted",c,d,f),c.set("direction",d)):f.fetch({reset:!0,success:function(){f.trigger("backgrid:sorted",c,d,f),c.set("direction",d)}})):(f.comparator=g,f.sort(),f.trigger("backgrid:sorted",c,d,f),c.set("direction",d)),this},makeComparator:function(a,b,c){return function(d,e){var f,g=c(d,a),h=c(e,a);return 1===b&&(f=g,g=h,h=f),g===h?0:g<h?-1:1}},moveToNextCell:function(a,b,c){var d,e,f,g,i,j=this.collection.indexOf(a),k=this.columns.indexOf(b);if(-1===k)return this;if(this.rows[j].cells[k].exitEditMode(),c.moveUp()||c.moveDown()||c.moveLeft()||c.moveRight()||c.save()){var l=this.columns.length,m=l*this.collection.length;if(c.moveUp()||c.moveDown()){g=j+(c.moveUp()?-1:1);var n=this.rows[g];n?(d=n.cells[k],h.callByNeed(d.column.editable(),d.column,a)&&(d.enterEditMode(),a.trigger("backgrid:next",g,k,!1))):a.trigger("backgrid:next",g,k,!0)}else if(c.moveLeft()||c.moveRight()){for(var o=c.moveRight(),p=j*l+k+(o?1:-1);p>=0&&p<m;o?p++:p--)if(g=~~(p/l),i=p-g*l,d=this.rows[g].cells[i],e=h.callByNeed(d.column.renderable(),d.column,d.model),f=h.callByNeed(d.column.editable(),d.column,a),e&&f){d.enterEditMode(),a.trigger("backgrid:next",g,i,!1);break}p==m&&a.trigger("backgrid:next",~~(p/l),p-g*l,!0)}}return this}});return h.Footer=b.View.extend({tagName:"tfoot",initialize:function(a){this.columns=a.columns,this.columns instanceof b.Collection||(this.columns=new h.Columns(this.columns))}}),h.Grid=b.View.extend({tagName:"table",className:"backgrid",header:G,body:H,footer:null,initialize:function(c){c.columns instanceof b.Collection||(c.columns=new C(c.columns||this.columns)),this.columns=c.columns,this.caption=c.caption;var d=a.omit(c,["el","id","attributes","className","tagName","events"]);this.body=c.body||this.body,this.body=new this.body(d),this.header=c.header||this.header,this.header&&(this.header=new this.header(d)),this.footer=c.footer||this.footer,this.footer&&(this.footer=new this.footer(d)),this.listenTo(this.columns,"reset",function(){this.header&&(this.header=new(this.header.remove().constructor)(d)),this.body=new(this.body.remove().constructor)(d),this.footer&&(this.footer=new(this.footer.remove().constructor)(d)),this.render()})},insertRow:function(){return this.body.insertRow.apply(this.body,arguments),this},removeRow:function(){return this.body.removeRow.apply(this.body,arguments),this},insertColumn:function(){return this.columns.add.apply(this.columns,arguments),this},removeColumn:function(){return this.columns.remove.apply(this.columns,arguments),this},sort:function(){return this.body.sort.apply(this.body,arguments),this},render:function(){return this.$el.empty(),this.caption&&this.$el.append(g("<caption>").text(this.caption)),this.header&&this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header&&this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),b.View.prototype.remove.apply(this,arguments)}}),h});
